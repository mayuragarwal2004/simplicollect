import{r as c,j as e,B as b,a as ne,k as oe,c as $,Q as S}from"./index.js";import{S as E,a as D,b as L,c as V,d as O,e as H,f as z}from"./select.js";import{A as ce,b as ie,a as de}from"./alert.js";import{u as me,f as Q,b as he,g as xe,c as ue,a as pe}from"./index14.js";import{T as ge,a as fe,b as K,c as je,d as Ne,e as W}from"./table2.js";import{I as be}from"./input.js";import{C as we,a as ve}from"./chevrons-right.js";import{C as Se}from"./chevron-left.js";import{C as Ce}from"./chevron-right.js";import{T as Pe,a as ke,b as ye,c as Ie}from"./tooltip.js";import{D as Me,a as Te,b as Re,c as Ae,d as $e}from"./dialog.js";import{S as Y}from"./scroll-area.js";import{C as Fe}from"./chevron-down.js";import{M as Ee}from"./minus.js";import{C as De}from"./chevron-up.js";import{P as Le}from"./plus.js";import{I as J}from"./info.js";import"./index10.js";import"./index4.js";import"./index11.js";import"./index9.js";import"./index5.js";import"./index7.js";import"./index8.js";import"./index12.js";import"./check.js";import"./index6.js";import"./index3.js";function Ve({columns:s,data:d,searchInputField:u,pagination:f,onRowSelectionChange:h,totalRecords:p,state:x}){var w;const[N,C]=c.useState({}),[P,y]=c.useState(""),m=(n,t,I)=>{const g=I.toLowerCase();return u?String(n.getValue(u)||"").toLowerCase().includes(g):!1},l=me({data:d,columns:s,getCoreRowModel:pe(),getPaginationRowModel:ue(),getSortedRowModel:xe(),getFilteredRowModel:he(),onGlobalFilterChange:y,globalFilterFn:m,onRowSelectionChange:n=>{if(C(n),h){const t=Object.keys(n).map(I=>d[parseInt(I)]);h(t)}},state:{...x,rowSelection:N,globalFilter:P}});return e.jsxs("div",{children:[u&&e.jsx("div",{className:"flex items-center py-4",children:e.jsx(be,{placeholder:"Search...",value:P??"",onChange:n=>y(String(n.target.value)),className:"max-w-sm"})}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ge,{children:[e.jsx(fe,{children:l.getHeaderGroups().map(n=>e.jsx(K,{children:n.headers.map(t=>e.jsx(je,{children:t.isPlaceholder?null:Q(t.column.columnDef.header,t.getContext())},t.id))},n.id))}),e.jsx(Ne,{children:(w=l.getRowModel().rows)!=null&&w.length?l.getRowModel().rows.map(n=>e.jsx(K,{"data-state":n.getIsSelected()&&"selected",children:n.getVisibleCells().map(t=>e.jsx(W,{children:Q(t.column.columnDef.cell,t.getContext())},t.id))},n.id)):e.jsx(K,{children:e.jsx(W,{colSpan:s.length,className:"h-24 text-center",children:"No results."})})})]})}),e.jsxs("div",{className:"flex items-center justify-between space-x-2 py-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Rows per page"}),e.jsxs(E,{value:`${l.getState().pagination.pageSize}`,onValueChange:n=>{l.setPageSize(Number(n))},children:[e.jsx(D,{className:"h-8 w-[70px]",children:e.jsx(L,{placeholder:l.getState().pagination.pageSize})}),e.jsx(V,{side:"top",children:[5,10,20,30,40,50].map(n=>e.jsx(O,{value:`${n}`,children:n},n))})]}),e.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium",children:["Page ",l.getState().pagination.pageIndex+1," of"," ",l.getPageCount()]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(b,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>l.setPageIndex(0),disabled:!l.getCanPreviousPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to first page"}),e.jsx(we,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>l.previousPage(),disabled:!l.getCanPreviousPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to previous page"}),e.jsx(Se,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>l.nextPage(),disabled:!l.getCanNextPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to next page"}),e.jsx(Ce,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>l.setPageIndex(l.getPageCount()-1),disabled:!l.getCanNextPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to last page"}),e.jsx(ve,{className:"h-4 w-4"})]})]})]}),p!==void 0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",l.getRowModel().rows.length," of ",p," records"]})]})}const X=({members:s,onToggle:d,icon:u})=>e.jsx("div",{className:"space-y-2",children:s.map(f=>e.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-muted rounded-lg cursor-pointer",onClick:()=>d(f),children:[e.jsxs("div",{className:"flex flex-col min-w-0 flex-1 mr-2",children:[e.jsx("span",{className:"font-medium text-sm md:text-base truncate",children:`${f.firstName} ${f.lastName}`}),e.jsxs("span",{className:"text-xs md:text-sm text-muted-foreground",children:["₹",f.dueAmount]})]}),e.jsx(u,{className:"h-4 w-4 md:h-5 md:w-5 flex-shrink-0 text-primary hover:text-primary/80"})]},f.memberId))}),Oe=({isOpen:s,onClose:d,members:u,onConfirm:f})=>{const[h,p]=c.useState([]),[x,N]=c.useState([]);c.useEffect(()=>{s&&u&&(p(u),N([]))},[s,u]);const C=(m,l=!1)=>{l?(N(x.filter(w=>w.memberId!==m.memberId)),p([...h,m])):(p(h.filter(w=>w.memberId!==m.memberId)),N([...x,m]))},P=m=>{m?(N([...x,...h]),p([])):(p([...h,...x]),N([]))},y=()=>{f(h),d()};return e.jsx(Me,{open:s,onOpenChange:d,children:e.jsxs(Te,{className:"max-w-3xl w-[95vw] max-h-[90vh] overflow-y-auto p-4 md:p-6 rounded-xl",children:[e.jsx(Re,{className:"mb-4",children:e.jsx(Ae,{className:"text-lg md:text-xl",children:"Select Members for Notification"})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:justify-between",children:[e.jsxs("h3",{className:"font-semibold text-sm md:text-base",children:["Members to Notify (",h.length,")"]}),e.jsxs(b,{variant:"outline",size:"sm",className:"w-full sm:w-auto text-sm",onClick:()=>P(!0),disabled:h.length===0,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Remove All"]})]}),e.jsx(Y,{className:"h-[200px] md:h-[300px] border rounded-lg p-2 md:p-4",children:e.jsx(X,{members:h,onToggle:m=>C(m,!1),icon:Ee})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:justify-between",children:[e.jsxs("h3",{className:"font-semibold text-sm md:text-base",children:["Excluded Members (",x.length,")"]}),e.jsxs(b,{variant:"outline",size:"sm",className:"w-full sm:w-auto text-sm",onClick:()=>P(!1),disabled:x.length===0,children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Add All"]})]}),e.jsx(Y,{className:"h-[200px] md:h-[300px] border rounded-lg p-2 md:p-4",children:e.jsx(X,{members:x,onToggle:m=>C(m,!0),icon:Le})})]})]}),e.jsxs($e,{className:"flex-col sm:flex-row gap-2 mt-4",children:[e.jsx(b,{variant:"outline",onClick:d,className:"w-full sm:w-auto",children:"Cancel"}),e.jsxs(b,{onClick:y,className:"w-full sm:w-auto",children:["Confirm Selection (",h.length,")"]})]})]})})},us=()=>{ne();const{chapterData:s}=oe(),[d,u]=c.useState([]),[f,h]=c.useState([]),[p,x]=c.useState(!1),[N,C]=c.useState(!1),[P,y]=c.useState([]),[m,l]=c.useState([]),[w,n]=c.useState([]),[t,I]=c.useState(""),[g,G]=c.useState(""),[v,B]=c.useState(""),[U,Z]=c.useState([]),_=[{accessorKey:"fullName",header:"Member",cell:({row:a})=>{const r=a.original;return`${r.firstName} ${r.lastName}`}},{accessorKey:"phoneNumber",header:"Phone Number",cell:({row:a})=>a.original.phoneNumber||"N/A"}];c.useEffect(()=>{if(!(s!=null&&s.chapterId))return;(async()=>{try{const{data:r}=await $.get(`/api/term/chapter/${s.chapterId}`);y(r)}catch(r){console.error("Error fetching terms:",r),S.error("Failed to fetch terms")}})()},[s]),console.log({selectedMembers:f}),c.useEffect(()=>{if(!(s!=null&&s.chapterId)||!t)return;(async()=>{try{const{data:r}=await $.get(`/api/packages/parents/${s.chapterId}?termId=${t}`);l(r),G(""),B("")}catch(r){console.error("Error fetching package parents:",r),S.error("Failed to fetch package parents")}})()},[s,t]),c.useEffect(()=>{if(!(s!=null&&s.chapterId)||!t||!g)return;(async()=>{try{const{data:r}=await $.get(`/api/packages/${s.chapterId}?termId=${t}&packageParent=${g}`);console.log({data:r}),n(r.data),B("")}catch(r){console.error("Error fetching packages:",r),S.error("Failed to fetch packages")}})()},[s,t,g]);const ee=async()=>{var a,r,k,M;if(!(s!=null&&s.chapterId)||!t||!g||!v){console.log("Missing required data:",{chapterId:s==null?void 0:s.chapterId,termId:t,packageParent:g,packageId:v});return}try{const o={termId:t,packageParent:g,packageId:v};console.log("Fetching member data with params:",o);const{data:T}=await $.get(`/api/broadcast/${s.chapterId}/dues-broadcast`,{params:o});console.log("Response:",T);const te=T.data.map(j=>{var A,q;const i=(j.packageData||[]).find(re=>re.packageId===v);if(!i)return null;const R=((A=i.calculatedResult)==null?void 0:A.totalAmount)||0,F=R>0||((q=i.calculatedResult)==null?void 0:q.message)==="Package has overlapping payments";return{...j,id:j.memberId,packageData:[i],dueAmount:R,hasDueAmount:F,fullName:`${j.firstName} ${j.lastName}`.toLowerCase()}}).filter(j=>j!==null&&j.hasDueAmount);u(te);const le=[{accessorKey:"dueAmount",header:()=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Due Amount"}),e.jsx(Pe,{children:e.jsxs(ke,{children:[e.jsx(ye,{children:e.jsx(J,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx(Ie,{children:e.jsx("p",{children:"Shows payment status or due amount"})})]})})]}),cell:({row:j})=>{var R,F,A;const i=j.original.packageData[0];return e.jsx("div",{className:"flex flex-col gap-1",children:((R=i==null?void 0:i.calculatedResult)==null?void 0:R.message)==="Package has overlapping payments"?e.jsx("span",{className:"text-green-500",children:"✔️"}):(F=i==null?void 0:i.calculatedResult)!=null&&F.totalAmount?e.jsxs("span",{className:"font-medium",children:["₹",i.calculatedResult.totalAmount]}):e.jsx("span",{className:"text-muted-foreground",children:((A=i==null?void 0:i.calculatedResult)==null?void 0:A.message)||"N/A"})})}}];Z([..._,...le])}catch(o){console.error("Failed to fetch member data:",{error:o.message,status:(a=o.response)==null?void 0:a.status,responseData:(r=o.response)==null?void 0:r.data,stack:o.stack}),S.error(((M=(k=o.response)==null?void 0:k.data)==null?void 0:M.message)||o.message||"Failed to fetch member data")}};c.useEffect(()=>{ee()},[s,t,g,v]);const se=async()=>{if(!d||d.length===0){S.error("No members found with due payments");return}C(!0)},ae=async a=>{var k,M;if(!a.length){S.error("Please select at least one member");return}const r=a.map(o=>{var T;return{memberId:o.memberId,firstName:o.firstName,lastName:o.lastName,phoneNumber:o.phoneNumber,dueAmount:o.dueAmount,packageName:(T=o.packageData[0])==null?void 0:T.packageName}});x(!0);try{const{data:o}=await $.post(`/api/broadcast/${s.chapterId}/send-dues-notification`,{members:r,termId:t,packageId:v});S.success(o.message||"Notifications sent successfully")}catch(o){console.error("Error sending notifications:",o),S.error(((M=(k=o.response)==null?void 0:k.data)==null?void 0:M.message)||"Failed to send notifications")}finally{x(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Payment Due Notification Broadcast"})}),e.jsxs(ce,{variant:"info",className:"mb-6",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(ie,{children:"Broadcast Information"}),e.jsx(de,{children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Select members from the list below to send payment due reminders via WhatsApp."}),e.jsx("li",{children:"Members must have a valid phone number to receive notifications."}),e.jsx("li",{children:"You can filter members by term and package parent to narrow down the list."}),e.jsx("li",{children:"Use the checkboxes to select/deselect members for notification."})]})})]}),e.jsxs("div",{className:"flex gap-4 flex-wrap",children:[e.jsxs(E,{value:t,onValueChange:I,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Term"})}),e.jsx(V,{children:e.jsxs(H,{children:[e.jsx(z,{children:"Term"}),P.map(a=>e.jsx(O,{value:a.termId,children:a.termName},a.termId))]})})]}),e.jsxs(E,{value:g,onValueChange:G,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Package Parent"})}),e.jsx(V,{children:e.jsxs(H,{children:[e.jsx(z,{children:"Package Parent"}),m.map(a=>e.jsx(O,{value:a,children:a},a))]})})]}),e.jsxs(E,{value:v,onValueChange:B,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Package"})}),e.jsx(V,{children:e.jsxs(H,{children:[e.jsx(z,{children:"Package"}),w.map(a=>e.jsx(O,{value:a.packageId,children:a.packageName},a.packageId))]})})]}),e.jsx(b,{onClick:se,disabled:!t||!v||!g||p||d.length===0,className:"ml-auto",children:p?"Sending...":"Send Notifications"})]}),U.length>0&&e.jsx("div",{className:"rounded-md border",children:e.jsx(Ve,{data:d,columns:U,searchInputField:"fullName",searchFunction:(a,r)=>{const k=r.toLowerCase();return a.fullName.includes(k)}})}),e.jsx(Oe,{isOpen:N,onClose:()=>C(!1),members:d,onConfirm:ae})]})};export{us as default};
