import{e as X,r as o,j as e,B as b,a as ce,l as oe,c as $,Q as S}from"./index.js";import{S as E,a as D,b as L,c as V,d as O,C as ie,e as z,f as H}from"./select.js";import{A as de,b as me,a as he}from"./alert.js";import{u as xe,f as U,b as ue,g as pe,c as ge,a as fe}from"./index14.js";import{T as je,a as Ne,b as _,c as be,d as we,e as Q}from"./table.js";import{I as ve}from"./input.js";import{C as Se}from"./chevron-left.js";import{C as Ce}from"./chevron-right.js";import{I as W,T as ke,a as ye,b as Pe,c as Ie}from"./tooltip.js";import{D as Me,a as Te,b as Re,c as Ae,d as $e}from"./dialog.js";import{S as Y}from"./scroll-area.js";import{C as Fe}from"./chevron-down.js";import{M as Ee}from"./minus.js";import{P as De}from"./plus.js";import"./index10.js";import"./index4.js";import"./index11.js";import"./index9.js";import"./index5.js";import"./index7.js";import"./index8.js";import"./index12.js";import"./index6.js";import"./index3.js";/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"m11 17-5-5 5-5",key:"13zhaf"}],["path",{d:"m18 17-5-5 5-5",key:"h8a8et"}]],Ve=X("ChevronsLeft",Le);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["path",{d:"m6 17 5-5-5-5",key:"xnjwq"}],["path",{d:"m13 17 5-5-5-5",key:"17xmmf"}]],Ge=X("ChevronsRight",Oe);function Be({columns:s,data:d,searchInputField:u,pagination:f,onRowSelectionChange:h,totalRecords:p,state:x}){var w;const[N,C]=o.useState({}),[k,P]=o.useState(""),m=(n,t,I)=>{const g=I.toLowerCase();return u?String(n.getValue(u)||"").toLowerCase().includes(g):!1},l=xe({data:d,columns:s,getCoreRowModel:fe(),getPaginationRowModel:ge(),getSortedRowModel:pe(),getFilteredRowModel:ue(),onGlobalFilterChange:P,globalFilterFn:m,onRowSelectionChange:n=>{if(C(n),h){const t=Object.keys(n).map(I=>d[parseInt(I)]);h(t)}},state:{...x,rowSelection:N,globalFilter:k}});return e.jsxs("div",{children:[u&&e.jsx("div",{className:"flex items-center py-4",children:e.jsx(ve,{placeholder:"Search...",value:k??"",onChange:n=>P(String(n.target.value)),className:"max-w-sm"})}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(je,{children:[e.jsx(Ne,{children:l.getHeaderGroups().map(n=>e.jsx(_,{children:n.headers.map(t=>e.jsx(be,{children:t.isPlaceholder?null:U(t.column.columnDef.header,t.getContext())},t.id))},n.id))}),e.jsx(we,{children:(w=l.getRowModel().rows)!=null&&w.length?l.getRowModel().rows.map(n=>e.jsx(_,{"data-state":n.getIsSelected()&&"selected",children:n.getVisibleCells().map(t=>e.jsx(Q,{children:U(t.column.columnDef.cell,t.getContext())},t.id))},n.id)):e.jsx(_,{children:e.jsx(Q,{colSpan:s.length,className:"h-24 text-center",children:"No results."})})})]})}),e.jsxs("div",{className:"flex items-center justify-between space-x-2 py-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Rows per page"}),e.jsxs(E,{value:`${l.getState().pagination.pageSize}`,onValueChange:n=>{l.setPageSize(Number(n))},children:[e.jsx(D,{className:"h-8 w-[70px]",children:e.jsx(L,{placeholder:l.getState().pagination.pageSize})}),e.jsx(V,{side:"top",children:[5,10,20,30,40,50].map(n=>e.jsx(O,{value:`${n}`,children:n},n))})]}),e.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium",children:["Page ",l.getState().pagination.pageIndex+1," of"," ",l.getPageCount()]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(b,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>l.setPageIndex(0),disabled:!l.getCanPreviousPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to first page"}),e.jsx(Ve,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>l.previousPage(),disabled:!l.getCanPreviousPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to previous page"}),e.jsx(Se,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>l.nextPage(),disabled:!l.getCanNextPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to next page"}),e.jsx(Ce,{className:"h-4 w-4"})]}),e.jsxs(b,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>l.setPageIndex(l.getPageCount()-1),disabled:!l.getCanNextPage(),children:[e.jsx("span",{className:"sr-only",children:"Go to last page"}),e.jsx(Ge,{className:"h-4 w-4"})]})]})]}),p!==void 0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",l.getRowModel().rows.length," of ",p," records"]})]})}const J=({members:s,onToggle:d,icon:u})=>e.jsx("div",{className:"space-y-2",children:s.map(f=>e.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-muted rounded-lg cursor-pointer",onClick:()=>d(f),children:[e.jsxs("div",{className:"flex flex-col min-w-0 flex-1 mr-2",children:[e.jsx("span",{className:"font-medium text-sm md:text-base truncate",children:`${f.firstName} ${f.lastName}`}),e.jsxs("span",{className:"text-xs md:text-sm text-muted-foreground",children:["₹",f.dueAmount]})]}),e.jsx(u,{className:"h-4 w-4 md:h-5 md:w-5 flex-shrink-0 text-primary hover:text-primary/80"})]},f.memberId))}),ze=({isOpen:s,onClose:d,members:u,onConfirm:f})=>{const[h,p]=o.useState([]),[x,N]=o.useState([]);o.useEffect(()=>{s&&u&&(p(u),N([]))},[s,u]);const C=(m,l=!1)=>{l?(N(x.filter(w=>w.memberId!==m.memberId)),p([...h,m])):(p(h.filter(w=>w.memberId!==m.memberId)),N([...x,m]))},k=m=>{m?(N([...x,...h]),p([])):(p([...h,...x]),N([]))},P=()=>{f(h),d()};return e.jsx(Me,{open:s,onOpenChange:d,children:e.jsxs(Te,{className:"max-w-3xl w-[95vw] max-h-[90vh] overflow-y-auto p-4 md:p-6 rounded-xl",children:[e.jsx(Re,{className:"mb-4",children:e.jsx(Ae,{className:"text-lg md:text-xl",children:"Select Members for Notification"})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:justify-between",children:[e.jsxs("h3",{className:"font-semibold text-sm md:text-base",children:["Members to Notify (",h.length,")"]}),e.jsxs(b,{variant:"outline",size:"sm",className:"w-full sm:w-auto text-sm",onClick:()=>k(!0),disabled:h.length===0,children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Remove All"]})]}),e.jsx(Y,{className:"h-[200px] md:h-[300px] border rounded-lg p-2 md:p-4",children:e.jsx(J,{members:h,onToggle:m=>C(m,!1),icon:Ee})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:justify-between",children:[e.jsxs("h3",{className:"font-semibold text-sm md:text-base",children:["Excluded Members (",x.length,")"]}),e.jsxs(b,{variant:"outline",size:"sm",className:"w-full sm:w-auto text-sm",onClick:()=>k(!1),disabled:x.length===0,children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Add All"]})]}),e.jsx(Y,{className:"h-[200px] md:h-[300px] border rounded-lg p-2 md:p-4",children:e.jsx(J,{members:x,onToggle:m=>C(m,!0),icon:De})})]})]}),e.jsxs($e,{className:"flex-col sm:flex-row gap-2 mt-4",children:[e.jsx(b,{variant:"outline",onClick:d,className:"w-full sm:w-auto",children:"Cancel"}),e.jsxs(b,{onClick:P,className:"w-full sm:w-auto",children:["Confirm Selection (",h.length,")"]})]})]})})},xs=()=>{ce();const{chapterData:s}=oe(),[d,u]=o.useState([]),[f,h]=o.useState([]),[p,x]=o.useState(!1),[N,C]=o.useState(!1),[k,P]=o.useState([]),[m,l]=o.useState([]),[w,n]=o.useState([]),[t,I]=o.useState(""),[g,G]=o.useState(""),[v,B]=o.useState(""),[K,Z]=o.useState([]),ee=[{accessorKey:"fullName",header:"Member",cell:({row:a})=>{const r=a.original;return`${r.firstName} ${r.lastName}`}},{accessorKey:"phoneNumber",header:"Phone Number",cell:({row:a})=>a.original.phoneNumber||"N/A"}];o.useEffect(()=>{if(!(s!=null&&s.chapterId))return;(async()=>{try{const{data:r}=await $.get(`/api/term/chapter/${s.chapterId}`);P(r)}catch(r){console.error("Error fetching terms:",r),S.error("Failed to fetch terms")}})()},[s]),console.log({selectedMembers:f}),o.useEffect(()=>{if(!(s!=null&&s.chapterId)||!t)return;(async()=>{try{const{data:r}=await $.get(`/api/packages/parents/${s.chapterId}?termId=${t}`);l(r),G(""),B("")}catch(r){console.error("Error fetching package parents:",r),S.error("Failed to fetch package parents")}})()},[s,t]),o.useEffect(()=>{if(!(s!=null&&s.chapterId)||!t||!g)return;(async()=>{try{const{data:r}=await $.get(`/api/packages/${s.chapterId}?termId=${t}&packageParent=${g}`);console.log({data:r}),n(r.data),B("")}catch(r){console.error("Error fetching packages:",r),S.error("Failed to fetch packages")}})()},[s,t,g]);const se=async()=>{var a,r,y,M;if(!(s!=null&&s.chapterId)||!t||!g||!v){console.log("Missing required data:",{chapterId:s==null?void 0:s.chapterId,termId:t,packageParent:g,packageId:v});return}try{const c={termId:t,packageParent:g,packageId:v};console.log("Fetching member data with params:",c);const{data:T}=await $.get(`/api/broadcast/${s.chapterId}/dues-broadcast`,{params:c});console.log("Response:",T);const le=T.data.map(j=>{var A,q;const i=(j.packageData||[]).find(ne=>ne.packageId===v);if(!i)return null;const R=((A=i.calculatedResult)==null?void 0:A.totalAmount)||0,F=R>0||((q=i.calculatedResult)==null?void 0:q.message)==="Package has overlapping payments";return{...j,id:j.memberId,packageData:[i],dueAmount:R,hasDueAmount:F,fullName:`${j.firstName} ${j.lastName}`.toLowerCase()}}).filter(j=>j!==null&&j.hasDueAmount);u(le);const re=[{accessorKey:"dueAmount",header:()=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Due Amount"}),e.jsx(ke,{children:e.jsxs(ye,{children:[e.jsx(Pe,{children:e.jsx(W,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx(Ie,{children:e.jsx("p",{children:"Shows payment status or due amount"})})]})})]}),cell:({row:j})=>{var R,F,A;const i=j.original.packageData[0];return e.jsx("div",{className:"flex flex-col gap-1",children:((R=i==null?void 0:i.calculatedResult)==null?void 0:R.message)==="Package has overlapping payments"?e.jsx("span",{className:"text-green-500",children:"✔️"}):(F=i==null?void 0:i.calculatedResult)!=null&&F.totalAmount?e.jsxs("span",{className:"font-medium",children:["₹",i.calculatedResult.totalAmount]}):e.jsx("span",{className:"text-muted-foreground",children:((A=i==null?void 0:i.calculatedResult)==null?void 0:A.message)||"N/A"})})}}];Z([...ee,...re])}catch(c){console.error("Failed to fetch member data:",{error:c.message,status:(a=c.response)==null?void 0:a.status,responseData:(r=c.response)==null?void 0:r.data,stack:c.stack}),S.error(((M=(y=c.response)==null?void 0:y.data)==null?void 0:M.message)||c.message||"Failed to fetch member data")}};o.useEffect(()=>{se()},[s,t,g,v]);const ae=async()=>{if(!d||d.length===0){S.error("No members found with due payments");return}C(!0)},te=async a=>{var y,M;if(!a.length){S.error("Please select at least one member");return}const r=a.map(c=>{var T;return{memberId:c.memberId,firstName:c.firstName,lastName:c.lastName,phoneNumber:c.phoneNumber,dueAmount:c.dueAmount,packageName:(T=c.packageData[0])==null?void 0:T.packageName}});x(!0);try{const{data:c}=await $.post(`/api/broadcast/${s.chapterId}/send-dues-notification`,{members:r,termId:t,packageId:v});S.success(c.message||"Notifications sent successfully")}catch(c){console.error("Error sending notifications:",c),S.error(((M=(y=c.response)==null?void 0:y.data)==null?void 0:M.message)||"Failed to send notifications")}finally{x(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center gap-4",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Payment Due Notification Broadcast"})}),e.jsxs(de,{variant:"info",className:"mb-6",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx(me,{children:"Broadcast Information"}),e.jsx(he,{children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Select members from the list below to send payment due reminders via WhatsApp."}),e.jsx("li",{children:"Members must have a valid phone number to receive notifications."}),e.jsx("li",{children:"You can filter members by term and package parent to narrow down the list."}),e.jsx("li",{children:"Use the checkboxes to select/deselect members for notification."})]})})]}),e.jsxs("div",{className:"flex gap-4 flex-wrap",children:[e.jsxs(E,{value:t,onValueChange:I,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Term"})}),e.jsx(V,{children:e.jsxs(z,{children:[e.jsx(H,{children:"Term"}),k.map(a=>e.jsx(O,{value:a.termId,children:a.termName},a.termId))]})})]}),e.jsxs(E,{value:g,onValueChange:G,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Package Parent"})}),e.jsx(V,{children:e.jsxs(z,{children:[e.jsx(H,{children:"Package Parent"}),m.map(a=>e.jsx(O,{value:a,children:a},a))]})})]}),e.jsxs(E,{value:v,onValueChange:B,children:[e.jsx(D,{className:"w-[180px]",children:e.jsx(L,{placeholder:"Select Package"})}),e.jsx(V,{children:e.jsxs(z,{children:[e.jsx(H,{children:"Package"}),w.map(a=>e.jsx(O,{value:a.packageId,children:a.packageName},a.packageId))]})})]}),e.jsx(b,{onClick:ae,disabled:!t||!v||!g||p||d.length===0,className:"ml-auto",children:p?"Sending...":"Send Notifications"})]}),K.length>0&&e.jsx("div",{className:"rounded-md border",children:e.jsx(Be,{data:d,columns:K,searchInputField:"fullName",searchFunction:(a,r)=>{const y=r.toLowerCase();return a.fullName.includes(y)}})}),e.jsx(ze,{isOpen:N,onClose:()=>C(!1),members:d,onConfirm:te})]})};export{xs as default};
