import{g as Q,r as g,Q as O,j as e,c as T,B as L,n as We,w as qe,_ as Qe,s as ze,G as pe,R as D,e as ae}from"./index-6elQxnHd.js";import{B as Ye}from"./Breadcrumb-ME0YvNli.js";import{f as H,C as Ge}from"./ChooseMemberPopoverCommand-sC98BC9i.js";import{T as Ke,a as Xe,b as he,c as ue}from"./tabs-DgvCMOhG.js";import{B as Ze}from"./badge-C8uzDnx2.js";import{C as Z}from"./circle-alert-BU0U2ACT.js";import{B as J}from"./banknote-VIhiFU9S.js";import{C as ee}from"./credit-card-YPGxKxDT.js";import{C as ge}from"./chevron-right-DA45-pzU.js";import{U as Je}from"./user-D86UelLv.js";import{S as et}from"./skeleton-Dmqt5wNo.js";import{S as tt}from"./switch-0nZFpl0y.js";import{L as at}from"./label-Duevo3Y3.js";import{C as st,S as nt,a as rt,b as it,c as ot,d as lt}from"./select-BctcFQZm.js";import{C as fe}from"./chevron-down-BUZeX_Bt.js";import{U as ct}from"./upload-BOrHq15E.js";import{C as xe}from"./chevron-left-DwqZmAJ3.js";import{A as dt,a as mt,b as ht,c as ut,f as pt,d as gt,g as ft,h as xt}from"./alert-dialog-BqU3jmle.js";import{D as vt,f as yt,a as bt}from"./dialog-CT_lOUQb.js";import{B as W,T as wt,a as jt}from"./Tabs-SqryRBx8.js";import{B as Ct}from"./Button-C3uzLm1J.js";import{I as Nt}from"./input-Dp_r379b.js";import{c as ve,e as se,d as ye,P as B,a as be,b as Pt}from"./index-BGKEPXry.js";import{c as At}from"./index-CWa4kTbH.js";import{P as _t}from"./index-CE4AQY6s.js";import{u as St}from"./index-BvgCK6ys.js";import"./popover-D0OZeFQ8.js";import"./index-BLdKwkXj.js";import"./index-BXCPHgg9.js";import"./index-BIhwVmuG.js";import"./command-DbqVVo4r.js";import"./index-CgP8r1n9.js";import"./search-C_1baVLY.js";import"./chevrons-up-down-j_XmOuyD.js";import"./index-DSJunp_n.js";import"./index-BdQq_4o_.js";import"./TransitionGroupContext-DpYB3VE9.js";import"./useSlot-DtiA9_Zl.js";import"./CircularProgress-zLMdsnkI.js";const we=(o,t,a,n)=>{const s=new Date(t.packagePayableEndDate);if(typeof t.meetingIds=="string"&&(t.meetingIds=JSON.parse(t.meetingIds)),t.status==="pending")return{message:"You have applied for this package. Please wait for approval",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};if(t.status==="rejected")return{message:"Your package application has been rejected",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};if(t.status==="approved")return{message:"Your package application has been approved",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};if(t.packagePayableStartDate&&o<new Date(t.packagePayableStartDate))return{message:"Package is not open to payable yet",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};if(!t.allowAfterEndDate&&o>s)return{message:"Package is not open to payable anymore",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};if(t.allowPackagePurchaseIfFeesPaid&&It(t,a))return{message:"Package has overlapping payments",totalAmount:null,penaltyAmount:null,discountAmount:null,isDisabled:!0};let i=t.packageFeeAmount,d=0,p=0;const c=(l,b)=>{switch(l){case"Daily":return b;case"Weekly":return Math.ceil(b/7);case"Monthly":return Math.ceil(b/30);case"Quarterly":return Math.ceil(b/90);case"lumpsum":case"Meetingly":return 1;default:return 0}};if(o<=new Date(t.discountEndDate)){const l=Math.ceil((new Date(t.discountEndDate)-o)/864e5);p=c(t.discountType,l)*t.discountAmount}if(o>s&&t.allowPenaltyPayableAfterEndDate){const l=Math.ceil((o-s)/864e5);d=c(t.penaltyType,l)*t.penaltyAmount}let y=i+d-p,u=0;return u=Array.isArray(t.meetingIds)?t.meetingIds.reduce((l,b)=>{const w=a.find(h=>h.meetingId===b);return l+(w&&w.isPaid?w.meetingFeeMembers:0)},0):0,{totalAmount:y-n,penaltyAmount:d,discountAmount:p,paidFees:u,previousBalance:n,isDisabled:!t.allowAfterEndDate&&o>s}},It=(o,t)=>{var a;return(a=o.meetingIds)==null?void 0:a.some(n=>{const s=t.find(i=>i.meetingId===n);return s&&s.isPaid})},je=g.createContext(),Rt=({children:o})=>{const{chapterData:t}=Q(),[a,n]=g.useState(new Date),[s,i]=g.useState({selectedReceiver:null,saveReceiverSelection:!1,selectedReceiverObject:null,receivers:[],selectedPackage:null,pendingPayments:[],packageData:null,parentType:null,terms:[],selectedTermId:null}),d=()=>{i(f=>({...f,selectedPackage:null,selectedReceiver:null,paymentMethod:"cash",selectedReceiverObject:null,saveReceiverSelection:!1}))},p=async()=>{try{const f=await T.get(`/api/feeReceiver/current/${t==null?void 0:t.chapterId}`,{params:{date:H(a)}}).then(r=>{console.log("Fetched Current Receivers:",r.data),i(m=>({...m,receivers:r.data}))}).catch(r=>console.error("Error fetching current receivers:",r))}catch(f){console.error("Error fetching current receivers:",f)}},c=async()=>{if(!(t!=null&&t.chapterId)){console.warn("Chapter ID is not available. Skipping terms fetch.");return}T.get(`/api/term/chapter/${t==null?void 0:t.chapterId}`).then(f=>{console.log("Fetched Terms:",f.data);const r=f.data.filter(m=>m.status==="active");if(!s.selectedTermId){let m=null;const N=new Date,P=r.find(A=>{const k=new Date(A.startDate),_=new Date(A.endDate);return N>=k&&N<=_});if(P)m=P.termId;else if(r.length>0){const A=r.filter(k=>new Date(k.startDate)>N);A.length>0?m=A.reduce((_,I)=>new Date(_.startDate)<new Date(I.startDate)?_:I).termId:m=r[0].termId}i(A=>({...A,terms:f.data,selectedTermId:m}))}}).catch(f=>console.error("Error fetching terms:",f))},y=async f=>{s.selectedTermId&&T.get(`/api/meetings/meetings/${t==null?void 0:t.chapterId}/term/${s.selectedTermId}`,{params:{memberId:f||""}}).then(r=>{console.log("Fetched Chapter Meetings:",r.data),i(m=>({...m,chapterMeetings:r.data}))}).catch(r=>console.error("Error fetching chapter meetings:",r))},u=async f=>{T.get(`/api/payment/balance/${t==null?void 0:t.chapterId}`,{params:{memberId:f||""}}).then(r=>{console.log("Fetched Due Amounts:",r.data),i(m=>({...m,balance:r.data.balance}))}).catch(r=>console.error("Error fetching balance amounts:",r))},x=async f=>{s.selectedTermId&&T.get(`/api/packages/all/${t==null?void 0:t.chapterId}/term/${s.selectedTermId}`,{params:{memberId:f||"",date:H(a)}}).then(r=>{const m=[...new Set(r.data.map(P=>P.packageParent))].sort((P,A)=>P.localeCompare(A)),N=l(r.data,s.balance);i(P=>({...P,packageParents:m,packageData:N,lastUpdated:new Date}))}).catch(r=>{console.error("Error fetching packages:",r)})},l=f=>f.map(r=>{const m=we(a,r,s.chapterMeetings,s.balance);return{...r,...m}}),b=async f=>{await T.get("/api/payment/pendingPayments",{params:{memberId:f||""}}).then(r=>{console.log("Fetched Pending Payments:",r.data),i(m=>({...m,pendingPayments:r.data}))}).catch(r=>console.error("Error fetching pending payments:",r))},w=async f=>{await T.delete(`/api/payment/deleteRequest/${f}`).then(r=>{h(),O.success("Request deleted successfully")}).catch(r=>console.error("Error deleting request:",r))},h=async f=>{await p(),await c(),await b(f),s.selectedTermId&&(await y(f),await u(f),await x(f))};return g.useEffect(()=>{s.chapterMeetings!==void 0&&s.balance!==void 0&&(console.log("Fetching Packages"),x(s.selectedMemberId))},[s.chapterMeetings,s.balance,s.selectedMemberId]),g.useEffect(()=>{t!=null&&t.chapterId&&h()},[t==null?void 0:t.chapterId,a,s.selectedTermId]),g.useEffect(()=>{if(s.selectedReceiver){const f=s.receivers.find(r=>r.receiverId===s.selectedReceiver);i(r=>({...r,selectedReceiverObject:f}))}},[s.selectedReceiver]),g.useEffect(()=>{const m=setInterval(()=>{const N=new Date,P=s.lastUpdated,A=s.lastSelectedPackageTime;N-P>3e5&&(s.selectedPackage?N-A>6e5?(O.warn("Payment window will timeout in 10 seconds..."),setTimeout(()=>{O.warn("Payment window has timed out. Refreshing data now..."),d(),h()},1e4)):O.warn("Refresh coming soon"):(O.warn("Data is stale. Refreshing now..."),h()))},6e4);return()=>clearInterval(m)},[s.lastUpdated,s.lastSelectedPackageTime]),console.log("From PaymentDataContext",{paymentData:s}),e.jsx(je.Provider,{value:{calculationDate:a,setCalculationDate:n,paymentData:s,setPaymentData:i,resetPaymentData:d,fetchAllData:h,handleDeletePendingRequest:w,setSelectedTermId:f=>i(r=>({...r,selectedTermId:f}))},children:o})},U=()=>{const o=g.useContext(je);if(!o)throw new Error("usePaymentData must be used within a PaymentDataProvider");return o},Dt=({setStep:o,handlePackagePayModalClose:t})=>{const{paymentData:a,setPaymentData:n}=U(),[s,i]=g.useState(!1),[d,p]=g.useState(""),c=()=>{a.paymentMethod?a.selectedReceiver?a.receivers.filter(u=>u.receiverId===a.selectedReceiver&&u.paymentType===a.paymentMethod).length===0?p("Invalid Receiver for the selected payment method"):(p(""),o(2)):p("Please select a receiver"):p("Please select a payment method")},y=u=>{const x=a.receivers.filter(l=>l.paymentType===u);return x.length===0?e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-center p-8 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:["No ",u==="cash"?"Cash":"Online"," Receivers Available"]}),e.jsxs("p",{className:"text-gray-500 mb-4",children:["There are currently no ",u==="cash"?"cash collection":"online payment"," receivers set up for this chapter."]}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Please contact your chapter admin to set up ",u==="cash"?"cash":"online"," receivers."]})]})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[u==="cash"?e.jsx(J,{className:"h-5 w-5 text-green-600"}):e.jsx(ee,{className:"h-5 w-5 text-blue-600"}),e.jsxs("h3",{className:"text-lg font-medium",children:["Select a ",u==="cash"?"Cash":"Online"," Receiver"]})]}),e.jsx("div",{className:"grid gap-3 max-h-60 overflow-y-auto pr-2",children:x.map(l=>e.jsx(We,{className:`cursor-pointer transition-all duration-200 hover:shadow-md ${a.selectedReceiver===l.receiverId?"border-blue-500 bg-blue-50 shadow-md":"border-gray-200 hover:border-gray-300"}`,onClick:()=>{n(b=>({...b,selectedReceiver:l.receiverId})),p("")},children:e.jsx(qe,{className:"p-3 sm:p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:`w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center ${a.selectedReceiver===l.receiverId?"bg-blue-100":"bg-gray-100"}`,children:e.jsx(Je,{className:`h-4 w-4 sm:h-5 sm:w-5 ${a.selectedReceiver===l.receiverId?"text-blue-600":"text-gray-600"}`})})}),e.jsx("div",{className:"min-w-0 flex-1",children:e.jsx("h4",{className:"font-medium text-gray-900 text-sm sm:text-base truncate",children:l.receiverName})})]}),a.selectedReceiver===l.receiverId&&e.jsx("div",{className:"flex-shrink-0 ml-2",children:e.jsx("div",{className:"w-5 h-5 sm:w-6 sm:h-6 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 sm:w-4 sm:h-4 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})})]})})},l.receiverId))}),d&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx(Z,{className:"h-4 w-4 text-red-500 flex-shrink-0"}),e.jsx("p",{className:"text-red-700 text-sm",children:d})]})]})};return g.useEffect(()=>{const u=a.receivers.filter(l=>l.paymentType==="cash"),x=a.receivers.filter(l=>l.paymentType==="online");u.length>0&&x.length>0?(n(l=>({...l,paymentMethod:l.paymentMethod||"cash"})),i(!0)):u.length>0?(n(l=>({...l,paymentMethod:"cash"})),i(!1)):(x.length>0&&n(l=>({...l,paymentMethod:"online"})),i(!1))},[a.receivers]),e.jsxs("div",{className:"flex flex-col h-full max-h-[80vh] overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0 pb-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:s?"Select Payment Method":"Payment Method"}),a.receivers.length===0&&e.jsx("p",{className:"text-gray-600 text-sm",children:"Choose how you'd like to make your payment"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto py-4 space-y-6 min-h-0",children:a.receivers.length===0?e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-center p-12 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(Z,{className:"mx-auto h-16 w-16 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-xl font-medium text-gray-900 mb-3",children:"No Payment Receivers Available"}),e.jsx("p",{className:"text-gray-600 mb-4 leading-relaxed",children:"There are currently no payment receivers set up for this chapter. Payment receivers are required to process your fee payment."}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-blue-800 text-sm font-medium mb-2",children:"What you can do:"}),e.jsxs("ul",{className:"text-blue-700 text-sm space-y-1 text-left",children:[e.jsx("li",{children:"• Contact your chapter administrator"}),e.jsx("li",{children:"• Ask them to set up cash or online receivers"}),e.jsx("li",{children:"• Try again once receivers are configured"})]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Chapter admins can set up receivers in the Fee Receiver management section"})]})})}):e.jsxs(Ke,{value:a.paymentMethod,className:"w-full",onValueChange:u=>{n(x=>({...x,paymentMethod:u,selectedReceiver:""})),p("")},children:[s?e.jsxs(Xe,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(he,{value:"cash",className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Cash"]}),e.jsxs(he,{value:"online",className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Online"]})]}):e.jsx("div",{className:"mb-6 p-4 border rounded-lg bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.paymentMethod==="cash"?e.jsx(J,{className:"h-5 w-5 text-blue-600"}):e.jsx(ee,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900",children:a.paymentMethod==="cash"?"Cash Payment":"Online Payment"}),e.jsx(Ze,{variant:"secondary",className:"ml-auto",children:"Only Available Method"})]})}),e.jsx(ue,{value:"cash",className:"mt-0",children:y("cash")}),e.jsx(ue,{value:"online",className:"mt-0",children:y("online")})]})}),e.jsx("div",{className:"flex-shrink-0 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx(L,{variant:"outline",onClick:()=>t(),children:"Cancel"}),a.receivers.length>0&&e.jsxs(L,{onClick:c,disabled:!a.selectedReceiver,children:["Next",e.jsx(ge,{className:"h-4 w-4 ml-1"})]})]})})]})};class C{constructor(t,a,n,s,i){this._legacyCanvasSize=C.DEFAULT_CANVAS_SIZE,this._preferredCamera="environment",this._maxScansPerSecond=25,this._lastScanTimestamp=-1,this._destroyed=this._flashOn=this._paused=this._active=!1,this.$video=t,this.$canvas=document.createElement("canvas"),n&&typeof n=="object"?this._onDecode=a:(console.warn(n||s||i?"You're using a deprecated version of the QrScanner constructor which will be removed in the future":"Note that the type of the scan result passed to onDecode will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),this._legacyOnDecode=a),a=typeof n=="object"?n:{},this._onDecodeError=a.onDecodeError||(typeof n=="function"?n:this._onDecodeError),this._calculateScanRegion=a.calculateScanRegion||(typeof s=="function"?s:this._calculateScanRegion),this._preferredCamera=a.preferredCamera||i||this._preferredCamera,this._legacyCanvasSize=typeof n=="number"?n:typeof s=="number"?s:this._legacyCanvasSize,this._maxScansPerSecond=a.maxScansPerSecond||this._maxScansPerSecond,this._onPlay=this._onPlay.bind(this),this._onLoadedMetaData=this._onLoadedMetaData.bind(this),this._onVisibilityChange=this._onVisibilityChange.bind(this),this._updateOverlay=this._updateOverlay.bind(this),t.disablePictureInPicture=!0,t.playsInline=!0,t.muted=!0;let d=!1;if(t.hidden&&(t.hidden=!1,d=!0),document.body.contains(t)||(document.body.appendChild(t),d=!0),n=t.parentElement,a.highlightScanRegion||a.highlightCodeOutline){if(s=!!a.overlay,this.$overlay=a.overlay||document.createElement("div"),i=this.$overlay.style,i.position="absolute",i.display="none",i.pointerEvents="none",this.$overlay.classList.add("scan-region-highlight"),!s&&a.highlightScanRegion){this.$overlay.innerHTML='<svg class="scan-region-highlight-svg" viewBox="0 0 238 238" preserveAspectRatio="none" style="position:absolute;width:100%;height:100%;left:0;top:0;fill:none;stroke:#e9b213;stroke-width:4;stroke-linecap:round;stroke-linejoin:round"><path d="M31 2H10a8 8 0 0 0-8 8v21M207 2h21a8 8 0 0 1 8 8v21m0 176v21a8 8 0 0 1-8 8h-21m-176 0H10a8 8 0 0 1-8-8v-21"/></svg>';try{this.$overlay.firstElementChild.animate({transform:["scale(.98)","scale(1.01)"]},{duration:400,iterations:1/0,direction:"alternate",easing:"ease-in-out"})}catch{}n.insertBefore(this.$overlay,this.$video.nextSibling)}a.highlightCodeOutline&&(this.$overlay.insertAdjacentHTML("beforeend",'<svg class="code-outline-highlight" preserveAspectRatio="none" style="display:none;width:100%;height:100%;fill:none;stroke:#e9b213;stroke-width:5;stroke-dasharray:25;stroke-linecap:round;stroke-linejoin:round"><polygon/></svg>'),this.$codeOutlineHighlight=this.$overlay.lastElementChild)}this._scanRegion=this._calculateScanRegion(t),requestAnimationFrame(()=>{let p=window.getComputedStyle(t);p.display==="none"&&(t.style.setProperty("display","block","important"),d=!0),p.visibility!=="visible"&&(t.style.setProperty("visibility","visible","important"),d=!0),d&&(console.warn("QrScanner has overwritten the video hiding style to avoid Safari stopping the playback."),t.style.opacity="0",t.style.width="0",t.style.height="0",this.$overlay&&this.$overlay.parentElement&&this.$overlay.parentElement.removeChild(this.$overlay),delete this.$overlay,delete this.$codeOutlineHighlight),this.$overlay&&this._updateOverlay()}),t.addEventListener("play",this._onPlay),t.addEventListener("loadedmetadata",this._onLoadedMetaData),document.addEventListener("visibilitychange",this._onVisibilityChange),window.addEventListener("resize",this._updateOverlay),this._qrEnginePromise=C.createQrEngine()}static set WORKER_PATH(t){console.warn("Setting QrScanner.WORKER_PATH is not required and not supported anymore. Have a look at the README for new setup instructions.")}static async hasCamera(){try{return!!(await C.listCameras(!1)).length}catch{return!1}}static async listCameras(t=!1){if(!navigator.mediaDevices)return[];let a=async()=>(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput"),n;try{t&&(await a()).every(s=>!s.label)&&(n=await navigator.mediaDevices.getUserMedia({audio:!1,video:!0}))}catch{}try{return(await a()).map((s,i)=>({id:s.deviceId,label:s.label||(i===0?"Default Camera":`Camera ${i+1}`)}))}finally{n&&(console.warn("Call listCameras after successfully starting a QR scanner to avoid creating a temporary video stream"),C._stopVideoStream(n))}}async hasFlash(){let t;try{if(this.$video.srcObject){if(!(this.$video.srcObject instanceof MediaStream))return!1;t=this.$video.srcObject}else t=(await this._getCameraStream()).stream;return"torch"in t.getVideoTracks()[0].getSettings()}catch{return!1}finally{t&&t!==this.$video.srcObject&&(console.warn("Call hasFlash after successfully starting the scanner to avoid creating a temporary video stream"),C._stopVideoStream(t))}}isFlashOn(){return this._flashOn}async toggleFlash(){this._flashOn?await this.turnFlashOff():await this.turnFlashOn()}async turnFlashOn(){if(!this._flashOn&&!this._destroyed&&(this._flashOn=!0,this._active&&!this._paused))try{if(!await this.hasFlash())throw"No flash available";await this.$video.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:!0}]})}catch(t){throw this._flashOn=!1,t}}async turnFlashOff(){this._flashOn&&(this._flashOn=!1,await this._restartVideoStream())}destroy(){this.$video.removeEventListener("loadedmetadata",this._onLoadedMetaData),this.$video.removeEventListener("play",this._onPlay),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("resize",this._updateOverlay),this._destroyed=!0,this._flashOn=!1,this.stop(),C._postWorkerMessage(this._qrEnginePromise,"close")}async start(){if(this._destroyed)throw Error("The QR scanner can not be started as it had been destroyed.");if((!this._active||this._paused)&&(window.location.protocol!=="https:"&&console.warn("The camera stream is only accessible if the page is transferred via https."),this._active=!0,!document.hidden))if(this._paused=!1,this.$video.srcObject)await this.$video.play();else try{let{stream:t,facingMode:a}=await this._getCameraStream();!this._active||this._paused?C._stopVideoStream(t):(this._setVideoMirror(a),this.$video.srcObject=t,await this.$video.play(),this._flashOn&&(this._flashOn=!1,this.turnFlashOn().catch(()=>{})))}catch(t){if(!this._paused)throw this._active=!1,t}}stop(){this.pause(),this._active=!1}async pause(t=!1){if(this._paused=!0,!this._active)return!0;this.$video.pause(),this.$overlay&&(this.$overlay.style.display="none");let a=()=>{this.$video.srcObject instanceof MediaStream&&(C._stopVideoStream(this.$video.srcObject),this.$video.srcObject=null)};return t?(a(),!0):(await new Promise(n=>setTimeout(n,300)),this._paused?(a(),!0):!1)}async setCamera(t){t!==this._preferredCamera&&(this._preferredCamera=t,await this._restartVideoStream())}static async scanImage(t,a,n,s,i=!1,d=!1){let p,c=!1;a&&("scanRegion"in a||"qrEngine"in a||"canvas"in a||"disallowCanvasResizing"in a||"alsoTryWithoutScanRegion"in a||"returnDetailedScanResult"in a)?(p=a.scanRegion,n=a.qrEngine,s=a.canvas,i=a.disallowCanvasResizing||!1,d=a.alsoTryWithoutScanRegion||!1,c=!0):console.warn(a||n||s||i||d?"You're using a deprecated api for scanImage which will be removed in the future.":"Note that the return type of scanImage will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),a=!!n;try{let y,u;[n,y]=await Promise.all([n||C.createQrEngine(),C._loadImage(t)]),[s,u]=C._drawToCanvas(y,p,s,i);let x;if(n instanceof Worker){let l=n;a||C._postWorkerMessageSync(l,"inversionMode","both"),x=await new Promise((b,w)=>{let h,f,r,m=-1;f=P=>{P.data.id===m&&(l.removeEventListener("message",f),l.removeEventListener("error",r),clearTimeout(h),P.data.data!==null?b({data:P.data.data,cornerPoints:C._convertPoints(P.data.cornerPoints,p)}):w(C.NO_QR_CODE_FOUND))},r=P=>{l.removeEventListener("message",f),l.removeEventListener("error",r),clearTimeout(h),w("Scanner error: "+(P?P.message||P:"Unknown Error"))},l.addEventListener("message",f),l.addEventListener("error",r),h=setTimeout(()=>r("timeout"),1e4);let N=u.getImageData(0,0,s.width,s.height);m=C._postWorkerMessageSync(l,"decode",N,[N.data.buffer])})}else x=await Promise.race([new Promise((l,b)=>window.setTimeout(()=>b("Scanner error: timeout"),1e4)),(async()=>{try{var[l]=await n.detect(s);if(!l)throw C.NO_QR_CODE_FOUND;return{data:l.rawValue,cornerPoints:C._convertPoints(l.cornerPoints,p)}}catch(b){if(l=b.message||b,/not implemented|service unavailable/.test(l))return C._disableBarcodeDetector=!0,C.scanImage(t,{scanRegion:p,canvas:s,disallowCanvasResizing:i,alsoTryWithoutScanRegion:d});throw`Scanner error: ${l}`}})()]);return c?x:x.data}catch(y){if(!p||!d)throw y;let u=await C.scanImage(t,{qrEngine:n,canvas:s,disallowCanvasResizing:i});return c?u:u.data}finally{a||C._postWorkerMessage(n,"close")}}setGrayscaleWeights(t,a,n,s=!0){C._postWorkerMessage(this._qrEnginePromise,"grayscaleWeights",{red:t,green:a,blue:n,useIntegerApproximation:s})}setInversionMode(t){C._postWorkerMessage(this._qrEnginePromise,"inversionMode",t)}static async createQrEngine(t){if(t&&console.warn("Specifying a worker path is not required and not supported anymore."),t=()=>Qe(()=>import("./qr-scanner-worker.min-D85Z9gVD.js"),[]).then(n=>n.createWorker()),!(!C._disableBarcodeDetector&&"BarcodeDetector"in window&&BarcodeDetector.getSupportedFormats&&(await BarcodeDetector.getSupportedFormats()).includes("qr_code")))return t();let a=navigator.userAgentData;return a&&a.brands.some(({brand:n})=>/Chromium/i.test(n))&&/mac ?OS/i.test(a.platform)&&await a.getHighEntropyValues(["architecture","platformVersion"]).then(({architecture:n,platformVersion:s})=>/arm/i.test(n||"arm")&&13<=parseInt(s||"13")).catch(()=>!0)?t():new BarcodeDetector({formats:["qr_code"]})}_onPlay(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay(),this.$overlay&&(this.$overlay.style.display=""),this._scanFrame()}_onLoadedMetaData(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay()}_onVisibilityChange(){document.hidden?this.pause():this._active&&this.start()}_calculateScanRegion(t){let a=Math.round(.6666666666666666*Math.min(t.videoWidth,t.videoHeight));return{x:Math.round((t.videoWidth-a)/2),y:Math.round((t.videoHeight-a)/2),width:a,height:a,downScaledWidth:this._legacyCanvasSize,downScaledHeight:this._legacyCanvasSize}}_updateOverlay(){requestAnimationFrame(()=>{if(this.$overlay){var t=this.$video,a=t.videoWidth,n=t.videoHeight,s=t.offsetWidth,i=t.offsetHeight,d=t.offsetLeft,p=t.offsetTop,c=window.getComputedStyle(t),y=c.objectFit,u=a/n,x=s/i;switch(y){case"none":var l=a,b=n;break;case"fill":l=s,b=i;break;default:(y==="cover"?u>x:u<x)?(b=i,l=b*u):(l=s,b=l/u),y==="scale-down"&&(l=Math.min(l,a),b=Math.min(b,n))}var[w,h]=c.objectPosition.split(" ").map((r,m)=>{const N=parseFloat(r);return r.endsWith("%")?(m?i-b:s-l)*N/100:N});c=this._scanRegion.width||a,x=this._scanRegion.height||n,y=this._scanRegion.x||0;var f=this._scanRegion.y||0;u=this.$overlay.style,u.width=`${c/a*l}px`,u.height=`${x/n*b}px`,u.top=`${p+h+f/n*b}px`,n=/scaleX\(-1\)/.test(t.style.transform),u.left=`${d+(n?s-w-l:w)+(n?a-y-c:y)/a*l}px`,u.transform=t.style.transform}})}static _convertPoints(t,a){if(!a)return t;let n=a.x||0,s=a.y||0,i=a.width&&a.downScaledWidth?a.width/a.downScaledWidth:1;a=a.height&&a.downScaledHeight?a.height/a.downScaledHeight:1;for(let d of t)d.x=d.x*i+n,d.y=d.y*a+s;return t}_scanFrame(){!this._active||this.$video.paused||this.$video.ended||("requestVideoFrameCallback"in this.$video?this.$video.requestVideoFrameCallback.bind(this.$video):requestAnimationFrame)(async()=>{if(!(1>=this.$video.readyState)){var t=Date.now()-this._lastScanTimestamp,a=1e3/this._maxScansPerSecond;t<a&&await new Promise(s=>setTimeout(s,a-t)),this._lastScanTimestamp=Date.now();try{var n=await C.scanImage(this.$video,{scanRegion:this._scanRegion,qrEngine:this._qrEnginePromise,canvas:this.$canvas})}catch(s){if(!this._active)return;this._onDecodeError(s)}!C._disableBarcodeDetector||await this._qrEnginePromise instanceof Worker||(this._qrEnginePromise=C.createQrEngine()),n?(this._onDecode?this._onDecode(n):this._legacyOnDecode&&this._legacyOnDecode(n.data),this.$codeOutlineHighlight&&(clearTimeout(this._codeOutlineHighlightRemovalTimeout),this._codeOutlineHighlightRemovalTimeout=void 0,this.$codeOutlineHighlight.setAttribute("viewBox",`${this._scanRegion.x||0} ${this._scanRegion.y||0} ${this._scanRegion.width||this.$video.videoWidth} ${this._scanRegion.height||this.$video.videoHeight}`),this.$codeOutlineHighlight.firstElementChild.setAttribute("points",n.cornerPoints.map(({x:s,y:i})=>`${s},${i}`).join(" ")),this.$codeOutlineHighlight.style.display="")):this.$codeOutlineHighlight&&!this._codeOutlineHighlightRemovalTimeout&&(this._codeOutlineHighlightRemovalTimeout=setTimeout(()=>this.$codeOutlineHighlight.style.display="none",100))}this._scanFrame()})}_onDecodeError(t){t!==C.NO_QR_CODE_FOUND&&console.log(t)}async _getCameraStream(){if(!navigator.mediaDevices)throw"Camera not found.";let t=/^(environment|user)$/.test(this._preferredCamera)?"facingMode":"deviceId",a=[{width:{min:1024}},{width:{min:768}},{}],n=a.map(s=>Object.assign({},s,{[t]:{exact:this._preferredCamera}}));for(let s of[...n,...a])try{let i=await navigator.mediaDevices.getUserMedia({video:s,audio:!1}),d=this._getFacingMode(i)||(s.facingMode?this._preferredCamera:this._preferredCamera==="environment"?"user":"environment");return{stream:i,facingMode:d}}catch{}throw"Camera not found."}async _restartVideoStream(){let t=this._paused;await this.pause(!0)&&!t&&this._active&&await this.start()}static _stopVideoStream(t){for(let a of t.getTracks())a.stop(),t.removeTrack(a)}_setVideoMirror(t){this.$video.style.transform="scaleX("+(t==="user"?-1:1)+")"}_getFacingMode(t){return(t=t.getVideoTracks()[0])?/rear|back|environment/i.test(t.label)?"environment":/front|user|face/i.test(t.label)?"user":null:null}static _drawToCanvas(t,a,n,s=!1){n=n||document.createElement("canvas");let i=a&&a.x?a.x:0,d=a&&a.y?a.y:0,p=a&&a.width?a.width:t.videoWidth||t.width,c=a&&a.height?a.height:t.videoHeight||t.height;return s||(s=a&&a.downScaledWidth?a.downScaledWidth:p,a=a&&a.downScaledHeight?a.downScaledHeight:c,n.width!==s&&(n.width=s),n.height!==a&&(n.height=a)),a=n.getContext("2d",{alpha:!1}),a.imageSmoothingEnabled=!1,a.drawImage(t,i,d,p,c,0,0,n.width,n.height),[n,a]}static async _loadImage(t){if(t instanceof Image)return await C._awaitImageLoad(t),t;if(t instanceof HTMLVideoElement||t instanceof HTMLCanvasElement||t instanceof SVGImageElement||"OffscreenCanvas"in window&&t instanceof OffscreenCanvas||"ImageBitmap"in window&&t instanceof ImageBitmap)return t;if(t instanceof File||t instanceof Blob||t instanceof URL||typeof t=="string"){let a=new Image;a.src=t instanceof File||t instanceof Blob?URL.createObjectURL(t):t.toString();try{return await C._awaitImageLoad(a),a}finally{(t instanceof File||t instanceof Blob)&&URL.revokeObjectURL(a.src)}}else throw"Unsupported image type."}static async _awaitImageLoad(t){t.complete&&t.naturalWidth!==0||await new Promise((a,n)=>{let s=i=>{t.removeEventListener("load",s),t.removeEventListener("error",s),i instanceof ErrorEvent?n("Image load error"):a()};t.addEventListener("load",s),t.addEventListener("error",s)})}static async _postWorkerMessage(t,a,n,s){return C._postWorkerMessageSync(await t,a,n,s)}static _postWorkerMessageSync(t,a,n,s){if(!(t instanceof Worker))return-1;let i=C._workerMessageId++;return t.postMessage({id:i,type:a,data:n},s),i}}C.DEFAULT_CANVAS_SIZE=400;C.NO_QR_CODE_FOUND="No QR code found";C._disableBarcodeDetector=!1;C._workerMessageId=0;const kt=({onClose:o,onPaymentSuccess:t,setStep:a,handlePackagePayModalClose:n})=>{const{paymentData:{selectedPackage:s,chapterMeetings:i,receivers:d,selectedReceiver:p,selectedReceiverObject:c,receiverFeeAmount:y,paymentProof:u,platformFee:x,platformFeeAmount:l,platformFeeType:b},setPaymentData:w}=U(),{chapterData:h}=Q();console.log({selectedPackage:s});const[f]=g.useState(new Date().toLocaleDateString()),[r,m]=g.useState(!1),[N,P]=g.useState([]),[A,k]=g.useState(!1),[_,I]=g.useState(!0),[E,R]=g.useState(s.totalAmount),[V,K]=g.useState(0);console.log({feeReceiverSwitch:_}),g.useEffect(()=>{if(s.meetingIds&&i){console.log("Hi mayur"),console.log(s.meetingIds),console.log(typeof s.meetingIds),console.log(i.map(S=>S.meetingId)),console.log("Hi mayur");const j=i.filter(S=>s.meetingIds.includes(S.meetingId));P(j)}},[s.meetingIds,i]),g.useEffect(()=>{if(c)if(c.receiverAmountType==="lumpsum"&&_)w(j=>({...j,receiverFeeAmount:c.receiverAmount}));else if(c.receiverAmountType==="percentage"&&_){const j=s.totalAmount*c.receiverAmount/100;w(S=>({...S,receiverFeeAmount:j}))}else w(j=>({...j,receiverFeeAmount:0}))},[c,s,_]),g.useEffect(()=>{if(h)if(h.platformFeeCase!=="per-payment")w(j=>({...j,platformFeeAmount:0}));else if(h.platformFeeType==="Lumpsum")w(j=>({...j,platformFeeAmount:h.platformFee}));else if(h.platformFeeType==="Percentage"){const j=s.totalAmount*h.platformFee;w(S=>({...S,platformFeeAmount:j}))}else w(j=>({...j,platformFeeAmount:0}))},[h,s]);const X=j=>{const S=j.target.files[0];S&&w(F=>({...F,paymentProof:S}))};return console.log({platformFeeAmount:l}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-[1000]",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-lg shadow-xl relative max-h-[90vh] overflow-y-auto",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800 text-center mb-4",children:"Payment Overview"}),e.jsxs("div",{className:"border p-4 rounded-lg mb-4 bg-gray-50",children:[e.jsx("p",{className:"text-gray-700 font-semibold text-lg",children:"Total Payable Amount:"}),e.jsxs("p",{className:"text-3xl font-bold text-blue-600",children:["₹",parseInt(s.totalAmount)+(parseInt(y)||0)+(parseInt(l)||0)]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-2",children:[e.jsxs("p",{children:["₹",s.packageFeeAmount," (Original Amount)"]}),s.penaltyAmount>0&&e.jsxs("p",{className:"text-red-500",children:["+ ₹",s.penaltyAmount," (Penalty)"]}),s.discountAmount>0&&e.jsxs("p",{className:"text-green-500",children:["- ₹",s.discountAmount," (Discount)"]}),s.previousBalance!==0&&e.jsxs("p",{className:"text-orange-500",children:[" ",s.previousBalance>0?"-":"+"," ₹",Math.abs(s.previousBalance)," (",s.previousBalance>0?"Advance":"Previous Due",")"]}),s.paidFees>0&&e.jsxs("p",{className:"text-blue-500",children:["- ₹",s.paidFees," (Paid Previously)"]}),y>0&&e.jsxs("p",{className:"text-blue-500",children:["+ ₹",y," (Receiver Fee)"]}),l>0&&e.jsxs("p",{className:"text-blue-500",children:["+ ₹",l," (Platform Fee)"]})]})]}),c.receiverFeeOptional!==0&&(c==null?void 0:c.receiverFeeOptional)&&e.jsxs("div",{className:"flex items-center space-x-4 my-4",children:[e.jsx(tt,{checked:_,onCheckedChange:j=>I(j),className:"h-5"}),e.jsx(at,{className:"text-lg",children:(c==null?void 0:c.receiverFeeOptionalMessage)||"Would you like to pay the receiver fee? (charges applicable)"})," "]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-700 font-semibold",children:"Meetings Included:"}),e.jsxs("button",{onClick:()=>m(!r),className:"flex items-center text-lg font-medium text-blue-500 hover:underline focus:outline-none",children:[N.length," Meetings",r?e.jsx(st,{className:"ml-2",size:18}):e.jsx(fe,{className:"ml-2",size:18})]}),r&&e.jsx("div",{className:"mt-2 max-h-[200px] overflow-y-auto",children:N.length>0?N==null?void 0:N.map(j=>e.jsxs("div",{className:`border p-2 rounded mb-2 ${j.isPaid?"bg-green-100":""}`,children:[e.jsx("p",{children:e.jsx("strong",{children:j.meetingName})}),e.jsxs("p",{children:[H(j.meetingDate)," at"," ",j.meetingTime]}),j.isPaid&&e.jsx("p",{className:"text-green-500 font-semibold",children:"Paid"})]},j.meetingId)):e.jsx("p",{children:"No meetings found"})})]}),e.jsxs("div",{children:["You are paying to ",c==null?void 0:c.receiverName,".",e.jsx("p",{className:"text-blue-500 cursor-pointer",onClick:()=>a(1),children:"Click here to change receiver."})]}),c&&c.qrImageLink&&e.jsxs("div",{className:"mt-4",children:[e.jsx(Et,{imageUrl:c.qrImageLink}),e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx(L,{variant:"outline",onClick:()=>{O.warn("This feature may not work on all browsers. If it doesn't work, please download the QR Code and scan it using a QR Code scanner app."),fetch(c.qrImageLink).then(j=>j.blob()).then(j=>{const S=URL.createObjectURL(j),F=new Image;F.crossOrigin="Anonymous",F.src=S,F.onload=async()=>{try{const v=await C.scanImage(F);console.log("QR Code content:",v),URL.revokeObjectURL(S),v.indexOf("://")||v.startsWith("http://")||v.startsWith("https://")?window.open(v,"_blank"):O.error("QR Code does not contain a valid link.")}catch(v){console.error("QR decoding failed:",v),O.error("Failed to decode QR Code.")}}}).catch(j=>{O.error("Error fetching QR Code image"),console.error(j)})},children:"Open QR Link"}),e.jsx(L,{variant:"outline",onClick:()=>{fetch(c.qrImageLink).then(j=>j.blob()).then(j=>{const S=document.createElement("a");S.href=URL.createObjectURL(j);const F=`QR_Code_${c.receiverName}.png`;S.download=F,S.click(),URL.revokeObjectURL(S.href)}).catch(j=>{O.error("Error downloading QR Code"),console.error(j)})},children:"Download QR Code"})]}),e.jsx("p",{className:"text-gray-700 font-semibold",children:"Upload Payment Proof:"}),e.jsxs("label",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-300 p-4 rounded-lg cursor-pointer hover:bg-gray-100 transition",children:[e.jsx(ct,{className:"text-gray-500",size:24}),e.jsx("span",{className:"text-gray-600 mt-2 text-sm",children:"Click to select or drag and drop an image here"}),e.jsx("input",{type:"file",name:"file",accept:"image/*",onChange:X,className:"hidden"})]}),u&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:["Uploaded: ",u.name]})]}),e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsxs(L,{variant:"outline",onClick:()=>a(1),children:[e.jsx(xe,{}),"Back"]}),e.jsxs(L,{onClick:()=>{w(j=>({...j,totalPayableAmount:(parseInt(s.totalAmount)||0)+(parseInt(y)||0)+(parseInt(l)||0)})),a(3)},children:["Next",e.jsx(ge,{})]})]})]})})},Et=({imageUrl:o})=>{const[t,a]=g.useState(!0);return e.jsxs("div",{className:"relative",children:[t&&e.jsx(et,{className:"w-full h-32 rounded-lg"})," ",e.jsx("img",{src:o,alt:"QR Code",className:`mb-2 rounded-lg ${t?"hidden":"block"}`,onLoad:()=>a(!1)})]})},Mt=({setStep:o,handlePackagePayModalClose:t})=>{const{paymentData:{selectedPackage:a,chapterMeetings:n,receivers:s,selectedReceiver:i,paymentProof:d,paymentDate:p,selectedReceiverObject:c,receiverFeeAmount:y,platformFeeAmount:u,totalPayableAmount:x,selectedMemberId:l},fetchAllData:b}=U(),{chapterData:w}=Q(),[h,f]=g.useState(x),r=h-x,[m,N]=g.useState(!1),[P,A]=g.useState(!1);console.log({selectedMemberId:l});const k=async()=>{A(!0);let _="";if(d){const E=new FormData;E.append("image",d),E.append("folderName","memberPaymentProofs"),_=await T.post("/api/image-upload",E,{headers:{"Content-Type":"multipart/form-data"}}).then(R=>(console.log("Payment Proof Uploaded:",R.data),R.data.imageUrl)),console.log("Payment Proof Link:",_)}const I={memberId:l,packageId:a.packageId,meetingIds:a.meetingIds,chapterId:w.chapterId,transactionType:"Package Payment",paidAmount:h,payableAmount:x,originalPayableAmount:parseFloat(a.packageFeeAmount),discountAmount:a.discountAmount,penaltyAmount:a.penaltyAmount,receiverFee:y,amountPaidToChapter:(parseFloat(h)||0)-(parseFloat(u)||0)-(parseFloat(y)||0),amountExpectedToChapter:a.totalAmount,platformFee:u,balanceAmount:r,paymentType:c==null?void 0:c.paymentType,paymentDate:p,paymentImageLink:_,paymentReceivedById:(c==null?void 0:c.memberId)||"",paymentReceivedByName:(c==null?void 0:c.receiverName)||""};await T.post("/api/payment/addPayment",I).then(E=>{var R;console.log("Payment submitted:",{selectedReceiver:i,paymentProof:d,paymentDate:p,paymentType:(R=s.find(V=>V.receiverId===i))==null?void 0:R.paymentType}),b(),t(),O.success("Payment submitted successfully")}).catch(E=>{console.error("Error submitting payment:",E),A(!1)}).finally(()=>{A(!1)})};return e.jsxs("div",{className:"p-6 max-w-md mx-auto bg-white rounded-xl shadow-md space-y-4",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900",children:["Total Payable Amount: ₹",x]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-700",children:"Enter Amount to Pay:"}),e.jsx("input",{type:"number",value:h,onChange:_=>{let I=Number(_.target.value);I<0&&(I=0),f(I)},className:"w-full p-2 border border-gray-300 rounded text-center"})]}),h===x?e.jsx("h3",{className:"text-xl font-semibold text-green-700",children:"You have paid the exact amount"}):h<x?e.jsxs("h3",{className:"text-xl font-semibold text-red-700",children:["You will be due by ₹",Math.abs(r)]}):e.jsxs("h3",{className:"text-xl font-semibold text-green-700",children:["You will pay advance of ₹",Math.abs(r)]}),e.jsxs("h5",{className:"text-sm font-semibold text-gray-700",children:["Amount will be received by: ",c==null?void 0:c.receiverName]}),e.jsxs(dt,{open:m,onOpenChange:N,children:[e.jsxs("div",{className:"flex justify-between mt-2",children:[e.jsxs(L,{variant:"outline",onClick:()=>o(2),children:[e.jsx(xe,{}),"Back"]}),e.jsx(L,{onClick:()=>N(!0),children:"Confirm"})]}),e.jsxs(mt,{children:[e.jsxs(ht,{children:[e.jsx(ut,{children:"Confirm Payment"}),e.jsxs(pt,{children:["Are you sure you want to confirm payment of ₹",h,"?",h>x&&e.jsxs("div",{className:"mt-2 text-green-700 font-semibold",children:["(You are paying ₹",Math.abs(r)," advance)"]}),h<x&&e.jsxs("div",{className:"mt-2 text-red-700 font-semibold",children:["(You will be due by ₹",Math.abs(r),")"]})]})]}),e.jsxs(gt,{children:[e.jsx(ft,{disabled:P,children:"Cancel"}),e.jsxs(xt,{onClick:k,disabled:P,className:"flex items-center justify-center",children:[P&&e.jsx(ze,{className:"mr-2 h-4 w-4 animate-spin"}),P?"Processing...":"Confirm"]})]})]})]})]})},Tt=({selectedPackage:o,pendingPayments:t,packageData:a,paymentSuccessHandler:n,parentType:s,chapterMeetings:i,handlePackagePayModalClose:d})=>{const{receivers:p}=U(),[c,y]=g.useState(1),[u,x]=g.useState(null),l=()=>{d()};return e.jsxs("div",{children:[c===1&&e.jsx(Dt,{selectedReceiver:u,setSelectedReceiver:x,packageData:a,setStep:y,handlePackagePayModalClose:d}),c===2&&e.jsx(kt,{selectedPackage:o,pendingPayments:t,packageData:a,paymentSuccessHandler:n,parentType:s,chapterMeetings:i,receivers:p,setStep:y,handlePackagePayModalClose:l}),c===3&&e.jsx(Mt,{setStep:y,handlePackagePayModalClose:l})]})},Ot=({pendingPayments:o,parentType:t,paymentSuccessHandler:a})=>{const{paymentData:{receivers:n,chapterMeetings:s,packageParents:i,selectedPackage:d,packageData:p},resetPaymentData:c,setPaymentData:y}=U(),[u,x]=g.useState(!1),[l,b]=g.useState(!0);console.log("From PackageCard",{receivers:n});const w=()=>{console.log("Triggered handlePackagePayModalClose"),c(),b(!1)};g.useEffect(()=>{b(!!d)},[d]),console.log({selectedPackage:d});const h=r=>{b(!0),y(m=>({...m,selectedPackage:r,lastSelectedPackageTime:new Date}))},f=p.filter(r=>r.packageParent===t).filter(r=>!u||!r.isPaid).sort((r,m)=>r.isDisabled!==m.isDisabled?r.isDisabled-m.isDisabled:0);return e.jsxs("div",{children:[e.jsx("div",{className:"flex justify-between items-center p-4 hidden",children:e.jsx("div",{className:"flex justify-end",children:e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:()=>x(!u),className:"form-checkbox"}),e.jsx("span",{children:"Show Unpaid Only"})]})})}),e.jsx(W,{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4",children:f.map(r=>e.jsxs("div",{className:`bg-white shadow-md rounded-lg p-6 border border-gray-200 hover:shadow-lg ${r.isDisabled?"opacity-50 cursor-not-allowed":""}`,children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:r.packageName}),!r.isDisabled&&r.totalAmount!==null&&r.status!=="approved"?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-gray-700 mb-1",children:[`₹${r.packageFeeAmount}`,r.penaltyAmount>0&&e.jsxs("span",{className:"text-red-500",children:[" ","+ ₹",r.penaltyAmount]}),r.discountAmount>0&&e.jsxs("span",{className:"text-green-500",children:[" ","- ₹",r.discountAmount]}),r.previousBalance!==0&&e.jsxs("span",{className:"text-orange-500",children:[" ",r.previousBalance>0?"-":"+"," ₹",Math.abs(r.previousBalance)," (",r.previousBalance>0?"Advance":"Previous Due",")"]}),"= ₹",r.totalAmount]}),e.jsxs("p",{className:"text-gray-700 mb-1",children:["Payable End Date:"," ",H(r.packagePayableEndDate)]}),e.jsx(Ct,{className:"mt-4 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700",variant:"contained",onClick:()=>h(r),disabled:r.isDisabled||(o==null?void 0:o.length)>0,children:"Pay Now"})]}):r.status==="approved"?e.jsx(e.Fragment,{children:e.jsxs("div",{children:["You have paid ₹",r.paidAmount," for this package on"," ",new Date(r.paymentDate).toLocaleDateString()," to"," ",e.jsx("b",{children:r.paymentReceivedByName})," by"," ",e.jsx("b",{children:r.paymentType})]})}):e.jsx("p",{className:"text-gray-700 mb-1",children:r.message||"Payment Not Allowed"})]},r.packageId))}),d&&n&&e.jsxs(vt,{open:l,onOpenChange:w,children:[e.jsx(yt,{}),e.jsx(bt,{className:"sm:max-w-[425px] p-4 max-w-[90%] rounded-lg",children:e.jsx(Tt,{selectedPackage:d,pendingPayments:o,packageData:p,paymentSuccessHandler:a,parentType:t,chapterMeetings:s,receivers:n,handlePackagePayModalClose:w})})]})]})};var z="Collapsible",[$t,Ce]=ve(z),[Ft,ne]=$t(z),Ne=g.forwardRef((o,t)=>{const{__scopeCollapsible:a,open:n,defaultOpen:s,disabled:i,onOpenChange:d,...p}=o,[c,y]=se({prop:n,defaultProp:s??!1,onChange:d,caller:z});return e.jsx(Ft,{scope:a,disabled:i,contentId:ye(),open:c,onOpenToggle:g.useCallback(()=>y(u=>!u),[y]),children:e.jsx(B.div,{"data-state":ie(c),"data-disabled":i?"":void 0,...p,ref:t})})});Ne.displayName=z;var Pe="CollapsibleTrigger",Ae=g.forwardRef((o,t)=>{const{__scopeCollapsible:a,...n}=o,s=ne(Pe,a);return e.jsx(B.button,{type:"button","aria-controls":s.contentId,"aria-expanded":s.open||!1,"data-state":ie(s.open),"data-disabled":s.disabled?"":void 0,disabled:s.disabled,...n,ref:t,onClick:be(o.onClick,s.onOpenToggle)})});Ae.displayName=Pe;var re="CollapsibleContent",_e=g.forwardRef((o,t)=>{const{forceMount:a,...n}=o,s=ne(re,o.__scopeCollapsible);return e.jsx(_t,{present:a||s.open,children:({present:i})=>e.jsx(Lt,{...n,ref:t,present:i})})});_e.displayName=re;var Lt=g.forwardRef((o,t)=>{const{__scopeCollapsible:a,present:n,children:s,...i}=o,d=ne(re,a),[p,c]=g.useState(n),y=g.useRef(null),u=pe(t,y),x=g.useRef(0),l=x.current,b=g.useRef(0),w=b.current,h=d.open||p,f=g.useRef(h),r=g.useRef(void 0);return g.useEffect(()=>{const m=requestAnimationFrame(()=>f.current=!1);return()=>cancelAnimationFrame(m)},[]),Pt(()=>{const m=y.current;if(m){r.current=r.current||{transitionDuration:m.style.transitionDuration,animationName:m.style.animationName},m.style.transitionDuration="0s",m.style.animationName="none";const N=m.getBoundingClientRect();x.current=N.height,b.current=N.width,f.current||(m.style.transitionDuration=r.current.transitionDuration,m.style.animationName=r.current.animationName),c(n)}},[d.open,n]),e.jsx(B.div,{"data-state":ie(d.open),"data-disabled":d.disabled?"":void 0,id:d.contentId,hidden:!h,...i,ref:u,style:{"--radix-collapsible-content-height":l?`${l}px`:void 0,"--radix-collapsible-content-width":w?`${w}px`:void 0,...o.style},children:h&&s})});function ie(o){return o?"open":"closed"}var Ut=Ne,Bt=Ae,Vt=_e,$="Accordion",Ht=["Home","End","ArrowDown","ArrowUp","ArrowLeft","ArrowRight"],[oe,Wt,qt]=At($),[Y,Wa]=ve($,[qt,Ce]),le=Ce(),Se=D.forwardRef((o,t)=>{const{type:a,...n}=o,s=n,i=n;return e.jsx(oe.Provider,{scope:o.__scopeAccordion,children:a==="multiple"?e.jsx(Gt,{...i,ref:t}):e.jsx(Yt,{...s,ref:t})})});Se.displayName=$;var[Ie,Qt]=Y($),[Re,zt]=Y($,{collapsible:!1}),Yt=D.forwardRef((o,t)=>{const{value:a,defaultValue:n,onValueChange:s=()=>{},collapsible:i=!1,...d}=o,[p,c]=se({prop:a,defaultProp:n??"",onChange:s,caller:$});return e.jsx(Ie,{scope:o.__scopeAccordion,value:D.useMemo(()=>p?[p]:[],[p]),onItemOpen:c,onItemClose:D.useCallback(()=>i&&c(""),[i,c]),children:e.jsx(Re,{scope:o.__scopeAccordion,collapsible:i,children:e.jsx(De,{...d,ref:t})})})}),Gt=D.forwardRef((o,t)=>{const{value:a,defaultValue:n,onValueChange:s=()=>{},...i}=o,[d,p]=se({prop:a,defaultProp:n??[],onChange:s,caller:$}),c=D.useCallback(u=>p((x=[])=>[...x,u]),[p]),y=D.useCallback(u=>p((x=[])=>x.filter(l=>l!==u)),[p]);return e.jsx(Ie,{scope:o.__scopeAccordion,value:d,onItemOpen:c,onItemClose:y,children:e.jsx(Re,{scope:o.__scopeAccordion,collapsible:!0,children:e.jsx(De,{...i,ref:t})})})}),[Kt,G]=Y($),De=D.forwardRef((o,t)=>{const{__scopeAccordion:a,disabled:n,dir:s,orientation:i="vertical",...d}=o,p=D.useRef(null),c=pe(p,t),y=Wt(a),x=St(s)==="ltr",l=be(o.onKeyDown,b=>{var I;if(!Ht.includes(b.key))return;const w=b.target,h=y().filter(E=>{var R;return!((R=E.ref.current)!=null&&R.disabled)}),f=h.findIndex(E=>E.ref.current===w),r=h.length;if(f===-1)return;b.preventDefault();let m=f;const N=0,P=r-1,A=()=>{m=f+1,m>P&&(m=N)},k=()=>{m=f-1,m<N&&(m=P)};switch(b.key){case"Home":m=N;break;case"End":m=P;break;case"ArrowRight":i==="horizontal"&&(x?A():k());break;case"ArrowDown":i==="vertical"&&A();break;case"ArrowLeft":i==="horizontal"&&(x?k():A());break;case"ArrowUp":i==="vertical"&&k();break}const _=m%r;(I=h[_].ref.current)==null||I.focus()});return e.jsx(Kt,{scope:a,disabled:n,direction:s,orientation:i,children:e.jsx(oe.Slot,{scope:a,children:e.jsx(B.div,{...d,"data-orientation":i,ref:c,onKeyDown:n?void 0:l})})})}),q="AccordionItem",[Xt,ce]=Y(q),ke=D.forwardRef((o,t)=>{const{__scopeAccordion:a,value:n,...s}=o,i=G(q,a),d=Qt(q,a),p=le(a),c=ye(),y=n&&d.value.includes(n)||!1,u=i.disabled||o.disabled;return e.jsx(Xt,{scope:a,open:y,disabled:u,triggerId:c,children:e.jsx(Ut,{"data-orientation":i.orientation,"data-state":Fe(y),...p,...s,ref:t,disabled:u,open:y,onOpenChange:x=>{x?d.onItemOpen(n):d.onItemClose(n)}})})});ke.displayName=q;var Ee="AccordionHeader",Me=D.forwardRef((o,t)=>{const{__scopeAccordion:a,...n}=o,s=G($,a),i=ce(Ee,a);return e.jsx(B.h3,{"data-orientation":s.orientation,"data-state":Fe(i.open),"data-disabled":i.disabled?"":void 0,...n,ref:t})});Me.displayName=Ee;var te="AccordionTrigger",Te=D.forwardRef((o,t)=>{const{__scopeAccordion:a,...n}=o,s=G($,a),i=ce(te,a),d=zt(te,a),p=le(a);return e.jsx(oe.ItemSlot,{scope:a,children:e.jsx(Bt,{"aria-disabled":i.open&&!d.collapsible||void 0,"data-orientation":s.orientation,id:i.triggerId,...p,...n,ref:t})})});Te.displayName=te;var Oe="AccordionContent",$e=D.forwardRef((o,t)=>{const{__scopeAccordion:a,...n}=o,s=G($,a),i=ce(Oe,a),d=le(a);return e.jsx(Vt,{role:"region","aria-labelledby":i.triggerId,"data-orientation":s.orientation,...d,...n,ref:t,style:{"--radix-accordion-content-height":"var(--radix-collapsible-content-height)","--radix-accordion-content-width":"var(--radix-collapsible-content-width)",...o.style}})});$e.displayName=Oe;function Fe(o){return o?"open":"closed"}var Zt=Se,Jt=ke,ea=Me,Le=Te,Ue=$e;const ta=Zt,Be=g.forwardRef(({className:o,...t},a)=>e.jsx(Jt,{ref:a,className:ae("border-b",o),...t}));Be.displayName="AccordionItem";const Ve=g.forwardRef(({className:o,children:t,...a},n)=>e.jsx(ea,{className:"flex",children:e.jsxs(Le,{ref:n,className:ae("flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180",o),...a,children:[t,e.jsx(fe,{className:"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200"})]})}));Ve.displayName=Le.displayName;const He=g.forwardRef(({className:o,children:t,...a},n)=>e.jsx(Ue,{ref:n,className:"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",...a,children:e.jsx("div",{className:ae("pb-4 pt-0",o),children:t})}));He.displayName=Ue.displayName;const aa=()=>{const{paymentData:{receivers:o,chapterMeetings:t,balance:a,packageParents:n,packageData:s,pendingPayments:i,terms:d,selectedTermId:p},calculationDate:c,setCalculationDate:y,setPaymentData:u,fetchAllData:x,handleDeletePendingRequest:l,setSelectedTermId:b}=U(),{chapterData:w,memberData:h}=Q(),[f,r]=D.useState(0),[m,N]=g.useState({value:h==null?void 0:h.memberId,label:`${h==null?void 0:h.firstName} ${h==null?void 0:h.lastName}`}),[P,A]=g.useState([]),[k,_]=g.useState([]),[I,E]=g.useState(!1),[R,V]=g.useState(!1),[K,X]=g.useState(!1);g.useEffect(()=>{h!=null&&h.memberId&&!m.value&&N({value:h==null?void 0:h.memberId,label:`${h==null?void 0:h.firstName} ${h==null?void 0:h.lastName}`})},[h]);const j=()=>{x(m.value)},S=(v,M)=>{r(M)},F=async()=>{try{const v=await T.get("/api/member/all",{params:{chapterId:w==null?void 0:w.chapterId}});_(v.data),A(v.data)}catch{toast.error("Error fetching members")}};return g.useEffect(()=>{w!=null&&w.chapterId&&R&&F()},[w,R]),g.useEffect(()=>{m&&(x(m.value),u(v=>({...v,selectedMemberId:m.value,selectedMemberName:m.label})))},[m]),g.useEffect(()=>{w!=null&&w.chapterId&&(T.get(`/api/rights/anyMemberMaketransaction/${w.chapterId}`).then(v=>{V(v.data.allowed)}).catch(v=>{console.error("Error fetching member transaction rights:",v)}),T.get(`/api/rights/changeDate/${w.chapterId}`).then(v=>{X(v.data.allowed)}).catch(v=>{console.error("Error fetching change date rights:",v)}))},[w]),console.log({calculationDate:c}),console.log({pendingPayments:i}),e.jsxs("div",{className:"rounded-sm border border-stroke bg-white p-3 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1",children:[i.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-yellow-100 rounded-md",children:[e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:["You have ",e.jsx("strong",{children:"pending payments"}),". Please contact admin to approve requests to continue."]}),e.jsx("button",{className:"px-3 py-1 text-sm font-semibold text-yellow-800 bg-yellow-300 rounded-md hover:bg-yellow-400 dark:text-yellow-200 dark:bg-yellow-400",onClick:x,children:"Refresh"})]}),e.jsx("div",{className:"mt-4",children:i.map(v=>{var M,de,me;return e.jsxs("div",{className:"mb-3 p-4 border border-yellow-300 rounded-lg bg-yellow-50 dark:bg-yellow-900/20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-yellow-900 dark:text-yellow-100",children:v.packageName}),e.jsxs("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:[v.packageFeeType," • ",new Date(v.paymentDate).toLocaleDateString()]})]}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200",children:v.status.toUpperCase()})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Paid:"}),e.jsxs("span",{className:"font-semibold text-green-700 dark:text-green-400",children:["₹",(M=v.paidAmount)==null?void 0:M.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Original Payable Amount:"}),e.jsxs("span",{className:"font-semibold text-blue-700 dark:text-blue-400",children:["₹",(de=v.payableAmount)==null?void 0:de.toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Balance:"}),e.jsxs("span",{className:`font-semibold ${v.balanceAmount<0?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400"}`,children:["₹",(me=Math.abs(v.balanceAmount))==null?void 0:me.toLocaleString(),v.balanceAmount<0?" Due":" Advance"]})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-yellow-200",children:[e.jsxs("div",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:[e.jsx("span",{className:"capitalize",children:v.paymentType})," •",e.jsx("span",{className:"ml-1",children:v.paymentReceivedByName||"Unknown"})]}),e.jsx("button",{className:"px-3 py-1 text-sm font-medium text-red-700 bg-red-100 border border-red-300 rounded hover:bg-red-200 dark:bg-red-900/30 dark:text-red-200 dark:border-red-600",onClick:()=>l(v.transactionId),children:"Delete"})]})]},v.transactionId)})})]}),e.jsxs("div",{className:"flex justify-between items-start flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("p",{className:"text-lg font-semibold text-gray-700 dark:text-gray-300 text-nowrap",children:"Current Date:"}),e.jsx("p",{className:"text-lg font-semibold text-gray-700 dark:text-gray-300 text-nowrap",children:e.jsx(na,{})})]}),(K||R)&&e.jsx(ta,{type:"single",collapsible:!0,children:e.jsxs(Be,{value:"item-1",children:[e.jsx(Ve,{children:"Additional Settings"}),e.jsxs(He,{children:[K&&e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx(Nt,{type:"date",value:c.toISOString().split("T")[0],onChange:v=>{const M=new Date(v.target.value);y(M),we(M,s,t,u)},placeholder:"Calculation Date"})}),R&&e.jsx("div",{className:"flex items-center space-x-4 mt-4",children:e.jsx(Ge,{members:k,selectedMember:m,setSelectedMember:N})})]})]})}),d&&d.filter(v=>v.status==="active").length>1&&e.jsxs("div",{className:"flex items-center space-x-4 mt-4",children:[e.jsx("label",{className:"text-md font-semibold",children:"Select Active Term:"}),e.jsxs(nt,{value:p||"",onValueChange:v=>{b(v),x(m==null?void 0:m.value)},children:[e.jsx(rt,{className:"w-[200px]",children:e.jsx(it,{placeholder:"Select term"})}),e.jsx(ot,{children:d.filter(v=>v.status==="active").map(v=>e.jsx(lt,{value:v.termId,children:v.termName},v.termId))})]})]})]}),!!a&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs("div",{className:"flex items-center space-x-2 text-nowrap",children:[e.jsxs("p",{className:"text-lg font-semibold text-gray-700 dark:text-gray-300",children:[a>0?"Advance Amount":"Due Amount",":"]}),e.jsxs("p",{className:`text-lg font-semibold ${a>0?"text-green-500":"text-red-500"}`,children:["₹",Math.abs(a)]})]})})]}),e.jsxs(W,{sx:{width:"100%"},children:[e.jsx(W,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsx(wt,{value:f,onChange:S,"aria-label":"fee tabs",children:n==null?void 0:n.map((v,M)=>e.jsx(jt,{label:v},M))})}),o&&(n==null?void 0:n.map((v,M)=>e.jsx(sa,{value:f,index:M,children:e.jsx(Ot,{pendingPayments:i,packageData:s,paymentSuccessHandler:j,parentType:v,receivers:o})},M)))]})]})};function sa(o){const{children:t,value:a,index:n,...s}=o;return e.jsx("div",{role:"tabpanel",hidden:a!==n,id:`simple-tabpanel-${n}`,"aria-labelledby":`simple-tab-${n}`,...s,children:a===n&&e.jsx(W,{sx:{p:3},children:t})})}const na=()=>{const[o,t]=g.useState(new Date);return g.useEffect(()=>{const a=setInterval(()=>{t(new Date)},1e3);return()=>clearInterval(a)},[]),e.jsxs("p",{className:"text-lg font-semibold text-gray-700 dark:text-gray-300",children:[o.getDate(),"-",o.getMonth()+1,"-",o.getFullYear()," ",o.getHours(),":",o.getMinutes().toString().padStart(2,"0"),":",o.getSeconds().toString().padStart(2,"0")]})},qa=()=>e.jsxs(e.Fragment,{children:[e.jsx(Ye,{items:[{name:"Packages",link:"/member/packages"}]}),e.jsx(Rt,{children:e.jsx(aa,{})})]});export{qa as default};
