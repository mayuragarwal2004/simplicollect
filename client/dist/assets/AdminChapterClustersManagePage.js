import{d as G,r as l,c as u,Q as h,j as e,B as E,n as O,t as A,v as H,G as B,w as V,f as L}from"./index.js";import{B as K}from"./Breadcrumb.js";import{T as Q,a as W,b as $,c as F}from"./tabs2.js";import{C as R}from"./checkbox.js";import{I as J}from"./input.js";import{T as D,a as U,b as S,c as C,d as _,e as b}from"./table.js";import{S as X}from"./search.js";import{S as Y,a as Z,b as ee,c as se,d as ae}from"./select.js";import{P as q}from"./package.js";import{U as te}from"./users.js";import"./chevron-right.js";import"./index4.js";import"./index11.js";import"./index9.js";import"./index6.js";import"./index12.js";import"./index8.js";import"./index10.js";import"./index5.js";import"./index7.js";import"./chevron-down.js";/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],z=G("Save",re),ce=({clusters:n,chapterSlug:o})=>{const[p,N]=l.useState([]),[i,x]=l.useState(""),[m,y]=l.useState({}),[g,k]=l.useState(!1);l.useEffect(()=>{v()},[o]);const v=async()=>{try{const a=await u.get(`/api/member/search/chapter/${o}?query=${i}&includeWithoutCluster=true`);N(a.data);const r={};a.data.forEach(s=>{r[s.memberId]={},n.forEach(c=>{r[s.memberId][c.clusterId]=s.clusterId===c.clusterId})}),y(r)}catch{h.error("Failed to fetch members")}},j=()=>{v()},T=(a,r,s)=>{y(c=>{const t={...c};return s?Object.keys(t[a]).forEach(d=>{t[a][d]=d===r}):t[a][r]=!1,k(!0),t})},M=async()=>{try{const a=[];if(Object.keys(m).forEach(r=>{const s=Object.keys(m[r]).find(t=>m[r][t]),c=p.find(t=>t.memberId===r);c&&c.clusterId!==s&&a.push({memberId:r,clusterId:s||null})}),a.length===0){h.info("No changes to save");return}await u.put(`/api/clusters/bulk-update-members/${o}`,{updates:a}),h.success("Member cluster assignments updated successfully"),k(!1),v()}catch{h.error("Failed to update member assignments")}},w=p.filter(a=>{var r,s;return((r=a.name)==null?void 0:r.toLowerCase().includes(i.toLowerCase()))||((s=a.phone)==null?void 0:s.includes(i))});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(X,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(J,{placeholder:"Search members by name or phone...",value:i,onChange:a=>x(a.target.value),onKeyPress:a=>a.key==="Enter"&&j(),className:"pl-10"})]}),e.jsx(E,{onClick:j,variant:"outline",children:"Search"}),g&&e.jsxs(E,{onClick:M,children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Save Changes"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(D,{children:[e.jsx(U,{children:e.jsxs(S,{children:[e.jsx(C,{className:"w-64",children:"Member"}),e.jsx(C,{className:"w-32",children:"Phone"}),n.map(a=>e.jsx(C,{className:"text-center min-w-32",children:a.clusterName},a.clusterId))]})}),e.jsx(_,{children:w.map(a=>e.jsxs(S,{children:[e.jsx(b,{className:"font-medium",children:a.name}),e.jsx(b,{children:a.phone}),n.map(r=>{var s;return e.jsx(b,{className:"text-center",children:e.jsx(R,{checked:((s=m[a.memberId])==null?void 0:s[r.clusterId])||!1,onCheckedChange:c=>T(a.memberId,r.clusterId,c)})},r.clusterId)})]},a.memberId))})]})}),w.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No members found. Try adjusting your search criteria."})]})},ne=({clusters:n,chapterSlug:o})=>{const[p,N]=l.useState([]),[i,x]=l.useState(""),[m,y]=l.useState([]),[g,k]=l.useState({}),[v,j]=l.useState(!1);l.useEffect(()=>{T()},[o]),l.useEffect(()=>{i&&M()},[i]);const T=async()=>{try{const s=await u.get(`/api/term/chapter/${o}`);N(s.data),s.data.length>0&&x(s.data[0].termId)}catch{h.error("Failed to fetch terms")}},M=async()=>{try{const s=await u.get(`/api/packages/admin/all/${o}/term/${i}`);y(s.data);const t=(await u.get(`/api/clusters/package-mappings/${o}/term/${i}`)).data,d={};s.data.forEach(f=>{d[f.packageId]={},n.forEach(I=>{d[f.packageId][I.clusterId]=t.some(P=>P.packageId===f.packageId&&P.clusterId===I.clusterId&&P.isActive)})}),k(d),j(!1)}catch{h.error("Failed to fetch packages")}},w=(s,c,t)=>{k(d=>({...d,[s]:{...d[s],[c]:t}})),j(!0)},a=async()=>{try{const s=[];Object.keys(g).forEach(c=>{Object.keys(g[c]).forEach(t=>{s.push({packageId:c,clusterId:t,isActive:g[c][t]})})}),await u.put(`/api/clusters/bulk-update-packages/${o}`,{updates:s}),h.success("Package cluster assignments updated successfully"),j(!1)}catch{h.error("Failed to update package assignments")}},r=m.reduce((s,c)=>{const t=c.packageParent||"Other";return s[t]||(s[t]=[]),s[t].push(c),s},{});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs(Y,{value:i,onValueChange:x,children:[e.jsx(Z,{className:"w-64",children:e.jsx(ee,{placeholder:"Select a term"})}),e.jsx(se,{children:p.map(s=>e.jsx(ae,{value:s.termId,children:s.termName},s.termId))})]})}),v&&e.jsxs(E,{onClick:a,children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"Save Changes"]})]}),i&&Object.keys(r).length>0?e.jsx("div",{className:"space-y-6",children:Object.entries(r).map(([s,c])=>e.jsxs(O,{children:[e.jsxs(A,{children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),s]}),e.jsx(B,{children:"Assign packages to clusters"})]}),e.jsx(V,{children:e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(D,{children:[e.jsx(U,{children:e.jsxs(S,{children:[e.jsx(C,{className:"w-64",children:"Package"}),e.jsx(C,{className:"w-32",children:"Amount"}),n.map(t=>e.jsx(C,{className:"text-center min-w-32",children:t.clusterName},t.clusterId))]})}),e.jsx(_,{children:c.map(t=>e.jsxs(S,{children:[e.jsx(b,{className:"font-medium",children:t.packageName}),e.jsxs(b,{children:["â‚¹",t.packageFeeAmount||0]}),n.map(d=>{var f;return e.jsx(b,{className:"text-center",children:e.jsx(R,{checked:((f=g[t.packageId])==null?void 0:f[d.clusterId])||!1,onCheckedChange:I=>w(t.packageId,d.clusterId,I)})},d.clusterId)})]},t.packageId))})]})})})]},s))}):i?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No packages found for the selected term."}):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Please select a term to view packages."})]})},le=()=>{const{chapterSlug:n}=L(),[o,p]=l.useState([]),[N,i]=l.useState("members");l.useEffect(()=>{x()},[n]);const x=async()=>{try{const m=await u.get(`/api/clusters/${n}`);p(m.data)}catch{h.error("Failed to fetch clusters")}};return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Manage Clusters"})}),e.jsxs(O,{children:[e.jsxs(A,{children:[e.jsx(H,{children:"Cluster Management"}),e.jsx(B,{children:"Manage member assignments and package assignments across all clusters"})]}),e.jsx(V,{children:e.jsxs(Q,{value:N,onValueChange:i,className:"w-full",children:[e.jsxs(W,{className:"grid w-full grid-cols-2",children:[e.jsxs($,{value:"members",className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),"Members"]}),e.jsxs($,{value:"packages",className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"Packages"]})]}),e.jsx(F,{value:"members",className:"mt-6",children:e.jsx(ce,{clusters:o,chapterSlug:n})}),e.jsx(F,{value:"packages",className:"mt-6",children:e.jsx(ne,{clusters:o,chapterSlug:n})})]})})]})]})},Me=()=>{const{chapterSlug:n}=L();return e.jsxs(e.Fragment,{children:[e.jsx(K,{items:[{name:"Dashboard",link:"/admin"},{name:"Chapter",link:"/admin/chapters"},{name:"Chapter Clusters",link:`/admin/chapters/${n}/clusters`},{name:"Manage Clusters",link:`/admin/chapters/${n}/clusters/manage`}]}),e.jsx(le,{})]})};export{Me as default};
